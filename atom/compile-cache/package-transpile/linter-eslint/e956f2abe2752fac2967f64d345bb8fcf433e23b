'use strict';
'use babel';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getNodePrefixPath = getNodePrefixPath;
exports.findESLintDirectory = findESLintDirectory;
exports.getESLintFromDirectory = getESLintFromDirectory;
exports.refreshModulesPath = refreshModulesPath;
exports.getESLintInstance = getESLintInstance;
exports.getConfigPath = getConfigPath;
exports.getRelativePath = getRelativePath;
exports.getCLIEngineOptions = getCLIEngineOptions;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _child_process = require('child_process');

var _child_process2 = _interopRequireDefault(_child_process);

var _resolveEnv = require('resolve-env');

var _resolveEnv2 = _interopRequireDefault(_resolveEnv);

var _atomLinter = require('atom-linter');

var _consistentPath = require('consistent-path');

var _consistentPath2 = _interopRequireDefault(_consistentPath);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const Cache = {
  ESLINT_LOCAL_PATH: _path2.default.normalize(_path2.default.join(__dirname, '..', 'node_modules', 'eslint')),
  NODE_PREFIX_PATH: null,
  LAST_MODULES_PATH: null
};

function getNodePrefixPath() {
  if (Cache.NODE_PREFIX_PATH === null) {
    const npmCommand = process.platform === 'win32' ? 'npm.cmd' : 'npm';
    try {
      Cache.NODE_PREFIX_PATH = _child_process2.default.spawnSync(npmCommand, ['get', 'prefix'], {
        env: Object.assign(Object.assign({}, process.env), { PATH: (0, _consistentPath2.default)() })
      }).output[1].toString().trim();
    } catch (e) {
      const errMsg = 'Unable to execute `npm get prefix`. Please make sure ' + 'Atom is getting $PATH correctly.';
      throw new Error(errMsg);
    }
  }
  return Cache.NODE_PREFIX_PATH;
}

function isDirectory(dirPath) {
  let isDir;
  try {
    isDir = _fs2.default.statSync(dirPath).isDirectory();
  } catch (e) {
    isDir = false;
  }
  return isDir;
}

function findESLintDirectory(modulesDir, config, projectPath) {
  let eslintDir = null;
  let locationType = null;
  if (config.useGlobalEslint) {
    locationType = 'global';
    const prefixPath = config.globalNodePath || getNodePrefixPath();
    // NPM on Windows and Yarn on all platforms
    eslintDir = _path2.default.join(prefixPath, 'node_modules', 'eslint');
    if (!isDirectory(eslintDir)) {
      // NPM on platforms other than Windows
      eslintDir = _path2.default.join(prefixPath, 'lib', 'node_modules', 'eslint');
    }
  } else if (!config.advancedLocalNodeModules) {
    locationType = 'local project';
    eslintDir = _path2.default.join(modulesDir || '', 'eslint');
  } else if (_path2.default.isAbsolute(config.advancedLocalNodeModules)) {
    locationType = 'advanced specified';
    eslintDir = _path2.default.join(config.advancedLocalNodeModules || '', 'eslint');
  } else {
    locationType = 'advanced specified';
    eslintDir = _path2.default.join(projectPath || '', config.advancedLocalNodeModules, 'eslint');
  }
  if (isDirectory(eslintDir)) {
    return {
      path: eslintDir,
      type: locationType
    };
  } else if (config.useGlobalEslint) {
    throw new Error('ESLint not found, please ensure the global Node path is set correctly.');
  }
  return {
    path: Cache.ESLINT_LOCAL_PATH,
    type: 'bundled fallback'
  };
}

function getESLintFromDirectory(modulesDir, config, projectPath) {
  var _findESLintDirectory = findESLintDirectory(modulesDir, config, projectPath);

  const ESLintDirectory = _findESLintDirectory.path;

  try {
    // eslint-disable-next-line import/no-dynamic-require
    return require(ESLintDirectory);
  } catch (e) {
    if (config.useGlobalEslint && e.code === 'MODULE_NOT_FOUND') {
      throw new Error('ESLint not found, try restarting Atom to clear caches.');
    }
    // eslint-disable-next-line import/no-dynamic-require
    return require(Cache.ESLINT_LOCAL_PATH);
  }
}

function refreshModulesPath(modulesDir) {
  if (Cache.LAST_MODULES_PATH !== modulesDir) {
    Cache.LAST_MODULES_PATH = modulesDir;
    process.env.NODE_PATH = modulesDir || '';
    // eslint-disable-next-line no-underscore-dangle
    require('module').Module._initPaths();
  }
}

function getESLintInstance(fileDir, config, projectPath) {
  const modulesDir = _path2.default.dirname((0, _atomLinter.findCached)(fileDir, 'node_modules/eslint') || '');
  refreshModulesPath(modulesDir);
  return getESLintFromDirectory(modulesDir, config, projectPath);
}

function getConfigPath(fileDir) {
  const configFile = (0, _atomLinter.findCached)(fileDir, ['.eslintrc.js', '.eslintrc.yaml', '.eslintrc.yml', '.eslintrc.json', '.eslintrc', 'package.json']);
  if (configFile) {
    if (_path2.default.basename(configFile) === 'package.json') {
      // eslint-disable-next-line import/no-dynamic-require
      if (require(configFile).eslintConfig) {
        return configFile;
      }
      // If we are here, we found a package.json without an eslint config
      // in a dir without any other eslint config files
      // (because 'package.json' is last in the call to findCached)
      // So, keep looking from the parent directory
      return getConfigPath(_path2.default.resolve(_path2.default.dirname(configFile), '..'));
    }
    return configFile;
  }
  return null;
}

function getRelativePath(fileDir, filePath, config, projectPath) {
  const ignoreFile = config.disableEslintIgnore ? null : (0, _atomLinter.findCached)(fileDir, '.eslintignore');

  // If we can find an .eslintignore file, we can set cwd there
  // (because they are expected to be at the project root)
  if (ignoreFile) {
    const ignoreDir = _path2.default.dirname(ignoreFile);
    process.chdir(ignoreDir);
    return _path2.default.relative(ignoreDir, filePath);
  }
  // Otherwise, we'll set the cwd to the atom project root as long as that exists
  if (projectPath) {
    process.chdir(projectPath);
    return _path2.default.relative(projectPath, filePath);
  }
  // If all else fails, use the file location itself
  process.chdir(fileDir);
  return _path2.default.basename(filePath);
}

function getCLIEngineOptions(type, config, rules, filePath, fileDir, givenConfigPath) {
  const cliEngineConfig = {
    rules,
    ignore: !config.disableEslintIgnore,
    warnIgnored: false,
    fix: type === 'fix'
  };

  const ignoreFile = config.disableEslintIgnore ? null : (0, _atomLinter.findCached)(fileDir, '.eslintignore');
  if (ignoreFile) {
    cliEngineConfig.ignorePath = ignoreFile;
  }

  if (config.eslintRulesDir) {
    let rulesDir = (0, _resolveEnv2.default)(config.eslintRulesDir);
    if (!_path2.default.isAbsolute(rulesDir)) {
      rulesDir = (0, _atomLinter.findCached)(fileDir, rulesDir);
    }
    if (rulesDir) {
      cliEngineConfig.rulePaths = [rulesDir];
    }
  }

  if (givenConfigPath === null && config.eslintrcPath) {
    // If we didn't find a configuration use the fallback from the settings
    cliEngineConfig.configFile = (0, _resolveEnv2.default)(config.eslintrcPath);
  }

  return cliEngineConfig;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtlci1oZWxwZXJzLmpzIl0sIm5hbWVzIjpbImdldE5vZGVQcmVmaXhQYXRoIiwiZmluZEVTTGludERpcmVjdG9yeSIsImdldEVTTGludEZyb21EaXJlY3RvcnkiLCJyZWZyZXNoTW9kdWxlc1BhdGgiLCJnZXRFU0xpbnRJbnN0YW5jZSIsImdldENvbmZpZ1BhdGgiLCJnZXRSZWxhdGl2ZVBhdGgiLCJnZXRDTElFbmdpbmVPcHRpb25zIiwiQ2FjaGUiLCJFU0xJTlRfTE9DQUxfUEFUSCIsIm5vcm1hbGl6ZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJOT0RFX1BSRUZJWF9QQVRIIiwiTEFTVF9NT0RVTEVTX1BBVEgiLCJucG1Db21tYW5kIiwicHJvY2VzcyIsInBsYXRmb3JtIiwic3Bhd25TeW5jIiwiZW52IiwiT2JqZWN0IiwiYXNzaWduIiwiUEFUSCIsIm91dHB1dCIsInRvU3RyaW5nIiwidHJpbSIsImUiLCJlcnJNc2ciLCJFcnJvciIsImlzRGlyZWN0b3J5IiwiZGlyUGF0aCIsImlzRGlyIiwic3RhdFN5bmMiLCJtb2R1bGVzRGlyIiwiY29uZmlnIiwicHJvamVjdFBhdGgiLCJlc2xpbnREaXIiLCJsb2NhdGlvblR5cGUiLCJ1c2VHbG9iYWxFc2xpbnQiLCJwcmVmaXhQYXRoIiwiZ2xvYmFsTm9kZVBhdGgiLCJhZHZhbmNlZExvY2FsTm9kZU1vZHVsZXMiLCJpc0Fic29sdXRlIiwicGF0aCIsInR5cGUiLCJFU0xpbnREaXJlY3RvcnkiLCJyZXF1aXJlIiwiY29kZSIsIk5PREVfUEFUSCIsIk1vZHVsZSIsIl9pbml0UGF0aHMiLCJmaWxlRGlyIiwiZGlybmFtZSIsImNvbmZpZ0ZpbGUiLCJiYXNlbmFtZSIsImVzbGludENvbmZpZyIsInJlc29sdmUiLCJmaWxlUGF0aCIsImlnbm9yZUZpbGUiLCJkaXNhYmxlRXNsaW50SWdub3JlIiwiaWdub3JlRGlyIiwiY2hkaXIiLCJyZWxhdGl2ZSIsInJ1bGVzIiwiZ2l2ZW5Db25maWdQYXRoIiwiY2xpRW5naW5lQ29uZmlnIiwiaWdub3JlIiwid2Fybklnbm9yZWQiLCJmaXgiLCJpZ25vcmVQYXRoIiwiZXNsaW50UnVsZXNEaXIiLCJydWxlc0RpciIsInJ1bGVQYXRocyIsImVzbGludHJjUGF0aCJdLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztRQWVnQkEsaUIsR0FBQUEsaUI7UUEyQkFDLG1CLEdBQUFBLG1CO1FBb0NBQyxzQixHQUFBQSxzQjtRQWNBQyxrQixHQUFBQSxrQjtRQVNBQyxpQixHQUFBQSxpQjtRQU1BQyxhLEdBQUFBLGE7UUFzQkFDLGUsR0FBQUEsZTtRQW9CQUMsbUIsR0FBQUEsbUI7O0FBbkpoQjs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQyxRQUFRO0FBQ1pDLHFCQUFtQixlQUFLQyxTQUFMLENBQWUsZUFBS0MsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLGNBQTNCLEVBQTJDLFFBQTNDLENBQWYsQ0FEUDtBQUVaQyxvQkFBa0IsSUFGTjtBQUdaQyxxQkFBbUI7QUFIUCxDQUFkOztBQU1PLFNBQVNkLGlCQUFULEdBQTZCO0FBQ2xDLE1BQUlRLE1BQU1LLGdCQUFOLEtBQTJCLElBQS9CLEVBQXFDO0FBQ25DLFVBQU1FLGFBQWFDLFFBQVFDLFFBQVIsS0FBcUIsT0FBckIsR0FBK0IsU0FBL0IsR0FBMkMsS0FBOUQ7QUFDQSxRQUFJO0FBQ0ZULFlBQU1LLGdCQUFOLEdBQ0Usd0JBQWFLLFNBQWIsQ0FBdUJILFVBQXZCLEVBQW1DLENBQUMsS0FBRCxFQUFRLFFBQVIsQ0FBbkMsRUFBc0Q7QUFDcERJLGFBQUtDLE9BQU9DLE1BQVAsQ0FBY0QsT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JMLFFBQVFHLEdBQTFCLENBQWQsRUFBOEMsRUFBRUcsTUFBTSwrQkFBUixFQUE5QztBQUQrQyxPQUF0RCxFQUVHQyxNQUZILENBRVUsQ0FGVixFQUVhQyxRQUZiLEdBRXdCQyxJQUZ4QixFQURGO0FBSUQsS0FMRCxDQUtFLE9BQU9DLENBQVAsRUFBVTtBQUNWLFlBQU1DLFNBQVMsMERBQ2Isa0NBREY7QUFFQSxZQUFNLElBQUlDLEtBQUosQ0FBVUQsTUFBVixDQUFOO0FBQ0Q7QUFDRjtBQUNELFNBQU9uQixNQUFNSyxnQkFBYjtBQUNEOztBQUVELFNBQVNnQixXQUFULENBQXFCQyxPQUFyQixFQUE4QjtBQUM1QixNQUFJQyxLQUFKO0FBQ0EsTUFBSTtBQUNGQSxZQUFRLGFBQUdDLFFBQUgsQ0FBWUYsT0FBWixFQUFxQkQsV0FBckIsRUFBUjtBQUNELEdBRkQsQ0FFRSxPQUFPSCxDQUFQLEVBQVU7QUFDVkssWUFBUSxLQUFSO0FBQ0Q7QUFDRCxTQUFPQSxLQUFQO0FBQ0Q7O0FBRU0sU0FBUzlCLG1CQUFULENBQTZCZ0MsVUFBN0IsRUFBeUNDLE1BQXpDLEVBQWlEQyxXQUFqRCxFQUE4RDtBQUNuRSxNQUFJQyxZQUFZLElBQWhCO0FBQ0EsTUFBSUMsZUFBZSxJQUFuQjtBQUNBLE1BQUlILE9BQU9JLGVBQVgsRUFBNEI7QUFDMUJELG1CQUFlLFFBQWY7QUFDQSxVQUFNRSxhQUFhTCxPQUFPTSxjQUFQLElBQXlCeEMsbUJBQTVDO0FBQ0E7QUFDQW9DLGdCQUFZLGVBQUt6QixJQUFMLENBQVU0QixVQUFWLEVBQXNCLGNBQXRCLEVBQXNDLFFBQXRDLENBQVo7QUFDQSxRQUFJLENBQUNWLFlBQVlPLFNBQVosQ0FBTCxFQUE2QjtBQUMzQjtBQUNBQSxrQkFBWSxlQUFLekIsSUFBTCxDQUFVNEIsVUFBVixFQUFzQixLQUF0QixFQUE2QixjQUE3QixFQUE2QyxRQUE3QyxDQUFaO0FBQ0Q7QUFDRixHQVRELE1BU08sSUFBSSxDQUFDTCxPQUFPTyx3QkFBWixFQUFzQztBQUMzQ0osbUJBQWUsZUFBZjtBQUNBRCxnQkFBWSxlQUFLekIsSUFBTCxDQUFVc0IsY0FBYyxFQUF4QixFQUE0QixRQUE1QixDQUFaO0FBQ0QsR0FITSxNQUdBLElBQUksZUFBS1MsVUFBTCxDQUFnQlIsT0FBT08sd0JBQXZCLENBQUosRUFBc0Q7QUFDM0RKLG1CQUFlLG9CQUFmO0FBQ0FELGdCQUFZLGVBQUt6QixJQUFMLENBQVV1QixPQUFPTyx3QkFBUCxJQUFtQyxFQUE3QyxFQUFpRCxRQUFqRCxDQUFaO0FBQ0QsR0FITSxNQUdBO0FBQ0xKLG1CQUFlLG9CQUFmO0FBQ0FELGdCQUFZLGVBQUt6QixJQUFMLENBQVV3QixlQUFlLEVBQXpCLEVBQTZCRCxPQUFPTyx3QkFBcEMsRUFBOEQsUUFBOUQsQ0FBWjtBQUNEO0FBQ0QsTUFBSVosWUFBWU8sU0FBWixDQUFKLEVBQTRCO0FBQzFCLFdBQU87QUFDTE8sWUFBTVAsU0FERDtBQUVMUSxZQUFNUDtBQUZELEtBQVA7QUFJRCxHQUxELE1BS08sSUFBSUgsT0FBT0ksZUFBWCxFQUE0QjtBQUNqQyxVQUFNLElBQUlWLEtBQUosQ0FBVSx3RUFBVixDQUFOO0FBQ0Q7QUFDRCxTQUFPO0FBQ0xlLFVBQU1uQyxNQUFNQyxpQkFEUDtBQUVMbUMsVUFBTTtBQUZELEdBQVA7QUFJRDs7QUFFTSxTQUFTMUMsc0JBQVQsQ0FBZ0MrQixVQUFoQyxFQUE0Q0MsTUFBNUMsRUFBb0RDLFdBQXBELEVBQWlFO0FBQUEsNkJBQ3BDbEMsb0JBQW9CZ0MsVUFBcEIsRUFBZ0NDLE1BQWhDLEVBQXdDQyxXQUF4QyxDQURvQzs7QUFBQSxRQUN4RFUsZUFEd0Qsd0JBQzlERixJQUQ4RDs7QUFFdEUsTUFBSTtBQUNGO0FBQ0EsV0FBT0csUUFBUUQsZUFBUixDQUFQO0FBQ0QsR0FIRCxDQUdFLE9BQU9uQixDQUFQLEVBQVU7QUFDVixRQUFJUSxPQUFPSSxlQUFQLElBQTBCWixFQUFFcUIsSUFBRixLQUFXLGtCQUF6QyxFQUE2RDtBQUMzRCxZQUFNLElBQUluQixLQUFKLENBQVUsd0RBQVYsQ0FBTjtBQUNEO0FBQ0Q7QUFDQSxXQUFPa0IsUUFBUXRDLE1BQU1DLGlCQUFkLENBQVA7QUFDRDtBQUNGOztBQUVNLFNBQVNOLGtCQUFULENBQTRCOEIsVUFBNUIsRUFBd0M7QUFDN0MsTUFBSXpCLE1BQU1NLGlCQUFOLEtBQTRCbUIsVUFBaEMsRUFBNEM7QUFDMUN6QixVQUFNTSxpQkFBTixHQUEwQm1CLFVBQTFCO0FBQ0FqQixZQUFRRyxHQUFSLENBQVk2QixTQUFaLEdBQXdCZixjQUFjLEVBQXRDO0FBQ0E7QUFDQWEsWUFBUSxRQUFSLEVBQWtCRyxNQUFsQixDQUF5QkMsVUFBekI7QUFDRDtBQUNGOztBQUVNLFNBQVM5QyxpQkFBVCxDQUEyQitDLE9BQTNCLEVBQW9DakIsTUFBcEMsRUFBNENDLFdBQTVDLEVBQXlEO0FBQzlELFFBQU1GLGFBQWEsZUFBS21CLE9BQUwsQ0FBYSw0QkFBV0QsT0FBWCxFQUFvQixxQkFBcEIsS0FBOEMsRUFBM0QsQ0FBbkI7QUFDQWhELHFCQUFtQjhCLFVBQW5CO0FBQ0EsU0FBTy9CLHVCQUF1QitCLFVBQXZCLEVBQW1DQyxNQUFuQyxFQUEyQ0MsV0FBM0MsQ0FBUDtBQUNEOztBQUVNLFNBQVM5QixhQUFULENBQXVCOEMsT0FBdkIsRUFBZ0M7QUFDckMsUUFBTUUsYUFDSiw0QkFBV0YsT0FBWCxFQUFvQixDQUNsQixjQURrQixFQUNGLGdCQURFLEVBQ2dCLGVBRGhCLEVBQ2lDLGdCQURqQyxFQUNtRCxXQURuRCxFQUNnRSxjQURoRSxDQUFwQixDQURGO0FBSUEsTUFBSUUsVUFBSixFQUFnQjtBQUNkLFFBQUksZUFBS0MsUUFBTCxDQUFjRCxVQUFkLE1BQThCLGNBQWxDLEVBQWtEO0FBQ2hEO0FBQ0EsVUFBSVAsUUFBUU8sVUFBUixFQUFvQkUsWUFBeEIsRUFBc0M7QUFDcEMsZUFBT0YsVUFBUDtBQUNEO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFPaEQsY0FBYyxlQUFLbUQsT0FBTCxDQUFhLGVBQUtKLE9BQUwsQ0FBYUMsVUFBYixDQUFiLEVBQXVDLElBQXZDLENBQWQsQ0FBUDtBQUNEO0FBQ0QsV0FBT0EsVUFBUDtBQUNEO0FBQ0QsU0FBTyxJQUFQO0FBQ0Q7O0FBRU0sU0FBUy9DLGVBQVQsQ0FBeUI2QyxPQUF6QixFQUFrQ00sUUFBbEMsRUFBNEN2QixNQUE1QyxFQUFvREMsV0FBcEQsRUFBaUU7QUFDdEUsUUFBTXVCLGFBQWF4QixPQUFPeUIsbUJBQVAsR0FBNkIsSUFBN0IsR0FBb0MsNEJBQVdSLE9BQVgsRUFBb0IsZUFBcEIsQ0FBdkQ7O0FBRUE7QUFDQTtBQUNBLE1BQUlPLFVBQUosRUFBZ0I7QUFDZCxVQUFNRSxZQUFZLGVBQUtSLE9BQUwsQ0FBYU0sVUFBYixDQUFsQjtBQUNBMUMsWUFBUTZDLEtBQVIsQ0FBY0QsU0FBZDtBQUNBLFdBQU8sZUFBS0UsUUFBTCxDQUFjRixTQUFkLEVBQXlCSCxRQUF6QixDQUFQO0FBQ0Q7QUFDRDtBQUNBLE1BQUl0QixXQUFKLEVBQWlCO0FBQ2ZuQixZQUFRNkMsS0FBUixDQUFjMUIsV0FBZDtBQUNBLFdBQU8sZUFBSzJCLFFBQUwsQ0FBYzNCLFdBQWQsRUFBMkJzQixRQUEzQixDQUFQO0FBQ0Q7QUFDRDtBQUNBekMsVUFBUTZDLEtBQVIsQ0FBY1YsT0FBZDtBQUNBLFNBQU8sZUFBS0csUUFBTCxDQUFjRyxRQUFkLENBQVA7QUFDRDs7QUFFTSxTQUFTbEQsbUJBQVQsQ0FBNkJxQyxJQUE3QixFQUFtQ1YsTUFBbkMsRUFBMkM2QixLQUEzQyxFQUFrRE4sUUFBbEQsRUFBNEROLE9BQTVELEVBQXFFYSxlQUFyRSxFQUFzRjtBQUMzRixRQUFNQyxrQkFBa0I7QUFDdEJGLFNBRHNCO0FBRXRCRyxZQUFRLENBQUNoQyxPQUFPeUIsbUJBRk07QUFHdEJRLGlCQUFhLEtBSFM7QUFJdEJDLFNBQUt4QixTQUFTO0FBSlEsR0FBeEI7O0FBT0EsUUFBTWMsYUFBYXhCLE9BQU95QixtQkFBUCxHQUE2QixJQUE3QixHQUFvQyw0QkFBV1IsT0FBWCxFQUFvQixlQUFwQixDQUF2RDtBQUNBLE1BQUlPLFVBQUosRUFBZ0I7QUFDZE8sb0JBQWdCSSxVQUFoQixHQUE2QlgsVUFBN0I7QUFDRDs7QUFFRCxNQUFJeEIsT0FBT29DLGNBQVgsRUFBMkI7QUFDekIsUUFBSUMsV0FBVywwQkFBV3JDLE9BQU9vQyxjQUFsQixDQUFmO0FBQ0EsUUFBSSxDQUFDLGVBQUs1QixVQUFMLENBQWdCNkIsUUFBaEIsQ0FBTCxFQUFnQztBQUM5QkEsaUJBQVcsNEJBQVdwQixPQUFYLEVBQW9Cb0IsUUFBcEIsQ0FBWDtBQUNEO0FBQ0QsUUFBSUEsUUFBSixFQUFjO0FBQ1pOLHNCQUFnQk8sU0FBaEIsR0FBNEIsQ0FBQ0QsUUFBRCxDQUE1QjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSVAsb0JBQW9CLElBQXBCLElBQTRCOUIsT0FBT3VDLFlBQXZDLEVBQXFEO0FBQ25EO0FBQ0FSLG9CQUFnQlosVUFBaEIsR0FBNkIsMEJBQVduQixPQUFPdUMsWUFBbEIsQ0FBN0I7QUFDRDs7QUFFRCxTQUFPUixlQUFQO0FBQ0QiLCJmaWxlIjoid29ya2VyLWhlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2pvc2gvZG90ZmlsZXMvYXRvbS9wYWNrYWdlcy9saW50ZXItZXNsaW50Iiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IFBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCBDaGlsZFByb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCByZXNvbHZlRW52IGZyb20gJ3Jlc29sdmUtZW52J1xuaW1wb3J0IHsgZmluZENhY2hlZCB9IGZyb20gJ2F0b20tbGludGVyJ1xuaW1wb3J0IGdldFBhdGggZnJvbSAnY29uc2lzdGVudC1wYXRoJ1xuXG5jb25zdCBDYWNoZSA9IHtcbiAgRVNMSU5UX0xPQ0FMX1BBVEg6IFBhdGgubm9ybWFsaXplKFBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdub2RlX21vZHVsZXMnLCAnZXNsaW50JykpLFxuICBOT0RFX1BSRUZJWF9QQVRIOiBudWxsLFxuICBMQVNUX01PRFVMRVNfUEFUSDogbnVsbFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm9kZVByZWZpeFBhdGgoKSB7XG4gIGlmIChDYWNoZS5OT0RFX1BSRUZJWF9QQVRIID09PSBudWxsKSB7XG4gICAgY29uc3QgbnBtQ29tbWFuZCA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicgPyAnbnBtLmNtZCcgOiAnbnBtJ1xuICAgIHRyeSB7XG4gICAgICBDYWNoZS5OT0RFX1BSRUZJWF9QQVRIID1cbiAgICAgICAgQ2hpbGRQcm9jZXNzLnNwYXduU3luYyhucG1Db21tYW5kLCBbJ2dldCcsICdwcmVmaXgnXSwge1xuICAgICAgICAgIGVudjogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwcm9jZXNzLmVudiksIHsgUEFUSDogZ2V0UGF0aCgpIH0pXG4gICAgICAgIH0pLm91dHB1dFsxXS50b1N0cmluZygpLnRyaW0oKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IGVyck1zZyA9ICdVbmFibGUgdG8gZXhlY3V0ZSBgbnBtIGdldCBwcmVmaXhgLiBQbGVhc2UgbWFrZSBzdXJlICcgK1xuICAgICAgICAnQXRvbSBpcyBnZXR0aW5nICRQQVRIIGNvcnJlY3RseS4nXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKVxuICAgIH1cbiAgfVxuICByZXR1cm4gQ2FjaGUuTk9ERV9QUkVGSVhfUEFUSFxufVxuXG5mdW5jdGlvbiBpc0RpcmVjdG9yeShkaXJQYXRoKSB7XG4gIGxldCBpc0RpclxuICB0cnkge1xuICAgIGlzRGlyID0gZnMuc3RhdFN5bmMoZGlyUGF0aCkuaXNEaXJlY3RvcnkoKVxuICB9IGNhdGNoIChlKSB7XG4gICAgaXNEaXIgPSBmYWxzZVxuICB9XG4gIHJldHVybiBpc0RpclxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZEVTTGludERpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoKSB7XG4gIGxldCBlc2xpbnREaXIgPSBudWxsXG4gIGxldCBsb2NhdGlvblR5cGUgPSBudWxsXG4gIGlmIChjb25maWcudXNlR2xvYmFsRXNsaW50KSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2dsb2JhbCdcbiAgICBjb25zdCBwcmVmaXhQYXRoID0gY29uZmlnLmdsb2JhbE5vZGVQYXRoIHx8IGdldE5vZGVQcmVmaXhQYXRoKClcbiAgICAvLyBOUE0gb24gV2luZG93cyBhbmQgWWFybiBvbiBhbGwgcGxhdGZvcm1zXG4gICAgZXNsaW50RGlyID0gUGF0aC5qb2luKHByZWZpeFBhdGgsICdub2RlX21vZHVsZXMnLCAnZXNsaW50JylcbiAgICBpZiAoIWlzRGlyZWN0b3J5KGVzbGludERpcikpIHtcbiAgICAgIC8vIE5QTSBvbiBwbGF0Zm9ybXMgb3RoZXIgdGhhbiBXaW5kb3dzXG4gICAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4ocHJlZml4UGF0aCwgJ2xpYicsICdub2RlX21vZHVsZXMnLCAnZXNsaW50JylcbiAgICB9XG4gIH0gZWxzZSBpZiAoIWNvbmZpZy5hZHZhbmNlZExvY2FsTm9kZU1vZHVsZXMpIHtcbiAgICBsb2NhdGlvblR5cGUgPSAnbG9jYWwgcHJvamVjdCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4obW9kdWxlc0RpciB8fCAnJywgJ2VzbGludCcpXG4gIH0gZWxzZSBpZiAoUGF0aC5pc0Fic29sdXRlKGNvbmZpZy5hZHZhbmNlZExvY2FsTm9kZU1vZHVsZXMpKSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2FkdmFuY2VkIHNwZWNpZmllZCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4oY29uZmlnLmFkdmFuY2VkTG9jYWxOb2RlTW9kdWxlcyB8fCAnJywgJ2VzbGludCcpXG4gIH0gZWxzZSB7XG4gICAgbG9jYXRpb25UeXBlID0gJ2FkdmFuY2VkIHNwZWNpZmllZCdcbiAgICBlc2xpbnREaXIgPSBQYXRoLmpvaW4ocHJvamVjdFBhdGggfHwgJycsIGNvbmZpZy5hZHZhbmNlZExvY2FsTm9kZU1vZHVsZXMsICdlc2xpbnQnKVxuICB9XG4gIGlmIChpc0RpcmVjdG9yeShlc2xpbnREaXIpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhdGg6IGVzbGludERpcixcbiAgICAgIHR5cGU6IGxvY2F0aW9uVHlwZSxcbiAgICB9XG4gIH0gZWxzZSBpZiAoY29uZmlnLnVzZUdsb2JhbEVzbGludCkge1xuICAgIHRocm93IG5ldyBFcnJvcignRVNMaW50IG5vdCBmb3VuZCwgcGxlYXNlIGVuc3VyZSB0aGUgZ2xvYmFsIE5vZGUgcGF0aCBpcyBzZXQgY29ycmVjdGx5LicpXG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwYXRoOiBDYWNoZS5FU0xJTlRfTE9DQUxfUEFUSCxcbiAgICB0eXBlOiAnYnVuZGxlZCBmYWxsYmFjaycsXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVTTGludEZyb21EaXJlY3RvcnkobW9kdWxlc0RpciwgY29uZmlnLCBwcm9qZWN0UGF0aCkge1xuICBjb25zdCB7IHBhdGg6IEVTTGludERpcmVjdG9yeSB9ID0gZmluZEVTTGludERpcmVjdG9yeShtb2R1bGVzRGlyLCBjb25maWcsIHByb2plY3RQYXRoKVxuICB0cnkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgcmV0dXJuIHJlcXVpcmUoRVNMaW50RGlyZWN0b3J5KVxuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGNvbmZpZy51c2VHbG9iYWxFc2xpbnQgJiYgZS5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRVNMaW50IG5vdCBmb3VuZCwgdHJ5IHJlc3RhcnRpbmcgQXRvbSB0byBjbGVhciBjYWNoZXMuJylcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICByZXR1cm4gcmVxdWlyZShDYWNoZS5FU0xJTlRfTE9DQUxfUEFUSClcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVmcmVzaE1vZHVsZXNQYXRoKG1vZHVsZXNEaXIpIHtcbiAgaWYgKENhY2hlLkxBU1RfTU9EVUxFU19QQVRIICE9PSBtb2R1bGVzRGlyKSB7XG4gICAgQ2FjaGUuTEFTVF9NT0RVTEVTX1BBVEggPSBtb2R1bGVzRGlyXG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9QQVRIID0gbW9kdWxlc0RpciB8fCAnJ1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgIHJlcXVpcmUoJ21vZHVsZScpLk1vZHVsZS5faW5pdFBhdGhzKClcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RVNMaW50SW5zdGFuY2UoZmlsZURpciwgY29uZmlnLCBwcm9qZWN0UGF0aCkge1xuICBjb25zdCBtb2R1bGVzRGlyID0gUGF0aC5kaXJuYW1lKGZpbmRDYWNoZWQoZmlsZURpciwgJ25vZGVfbW9kdWxlcy9lc2xpbnQnKSB8fCAnJylcbiAgcmVmcmVzaE1vZHVsZXNQYXRoKG1vZHVsZXNEaXIpXG4gIHJldHVybiBnZXRFU0xpbnRGcm9tRGlyZWN0b3J5KG1vZHVsZXNEaXIsIGNvbmZpZywgcHJvamVjdFBhdGgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25maWdQYXRoKGZpbGVEaXIpIHtcbiAgY29uc3QgY29uZmlnRmlsZSA9XG4gICAgZmluZENhY2hlZChmaWxlRGlyLCBbXG4gICAgICAnLmVzbGludHJjLmpzJywgJy5lc2xpbnRyYy55YW1sJywgJy5lc2xpbnRyYy55bWwnLCAnLmVzbGludHJjLmpzb24nLCAnLmVzbGludHJjJywgJ3BhY2thZ2UuanNvbidcbiAgICBdKVxuICBpZiAoY29uZmlnRmlsZSkge1xuICAgIGlmIChQYXRoLmJhc2VuYW1lKGNvbmZpZ0ZpbGUpID09PSAncGFja2FnZS5qc29uJykge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgIGlmIChyZXF1aXJlKGNvbmZpZ0ZpbGUpLmVzbGludENvbmZpZykge1xuICAgICAgICByZXR1cm4gY29uZmlnRmlsZVxuICAgICAgfVxuICAgICAgLy8gSWYgd2UgYXJlIGhlcmUsIHdlIGZvdW5kIGEgcGFja2FnZS5qc29uIHdpdGhvdXQgYW4gZXNsaW50IGNvbmZpZ1xuICAgICAgLy8gaW4gYSBkaXIgd2l0aG91dCBhbnkgb3RoZXIgZXNsaW50IGNvbmZpZyBmaWxlc1xuICAgICAgLy8gKGJlY2F1c2UgJ3BhY2thZ2UuanNvbicgaXMgbGFzdCBpbiB0aGUgY2FsbCB0byBmaW5kQ2FjaGVkKVxuICAgICAgLy8gU28sIGtlZXAgbG9va2luZyBmcm9tIHRoZSBwYXJlbnQgZGlyZWN0b3J5XG4gICAgICByZXR1cm4gZ2V0Q29uZmlnUGF0aChQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKGNvbmZpZ0ZpbGUpLCAnLi4nKSlcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ0ZpbGVcbiAgfVxuICByZXR1cm4gbnVsbFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVsYXRpdmVQYXRoKGZpbGVEaXIsIGZpbGVQYXRoLCBjb25maWcsIHByb2plY3RQYXRoKSB7XG4gIGNvbnN0IGlnbm9yZUZpbGUgPSBjb25maWcuZGlzYWJsZUVzbGludElnbm9yZSA/IG51bGwgOiBmaW5kQ2FjaGVkKGZpbGVEaXIsICcuZXNsaW50aWdub3JlJylcblxuICAvLyBJZiB3ZSBjYW4gZmluZCBhbiAuZXNsaW50aWdub3JlIGZpbGUsIHdlIGNhbiBzZXQgY3dkIHRoZXJlXG4gIC8vIChiZWNhdXNlIHRoZXkgYXJlIGV4cGVjdGVkIHRvIGJlIGF0IHRoZSBwcm9qZWN0IHJvb3QpXG4gIGlmIChpZ25vcmVGaWxlKSB7XG4gICAgY29uc3QgaWdub3JlRGlyID0gUGF0aC5kaXJuYW1lKGlnbm9yZUZpbGUpXG4gICAgcHJvY2Vzcy5jaGRpcihpZ25vcmVEaXIpXG4gICAgcmV0dXJuIFBhdGgucmVsYXRpdmUoaWdub3JlRGlyLCBmaWxlUGF0aClcbiAgfVxuICAvLyBPdGhlcndpc2UsIHdlJ2xsIHNldCB0aGUgY3dkIHRvIHRoZSBhdG9tIHByb2plY3Qgcm9vdCBhcyBsb25nIGFzIHRoYXQgZXhpc3RzXG4gIGlmIChwcm9qZWN0UGF0aCkge1xuICAgIHByb2Nlc3MuY2hkaXIocHJvamVjdFBhdGgpXG4gICAgcmV0dXJuIFBhdGgucmVsYXRpdmUocHJvamVjdFBhdGgsIGZpbGVQYXRoKVxuICB9XG4gIC8vIElmIGFsbCBlbHNlIGZhaWxzLCB1c2UgdGhlIGZpbGUgbG9jYXRpb24gaXRzZWxmXG4gIHByb2Nlc3MuY2hkaXIoZmlsZURpcilcbiAgcmV0dXJuIFBhdGguYmFzZW5hbWUoZmlsZVBhdGgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDTElFbmdpbmVPcHRpb25zKHR5cGUsIGNvbmZpZywgcnVsZXMsIGZpbGVQYXRoLCBmaWxlRGlyLCBnaXZlbkNvbmZpZ1BhdGgpIHtcbiAgY29uc3QgY2xpRW5naW5lQ29uZmlnID0ge1xuICAgIHJ1bGVzLFxuICAgIGlnbm9yZTogIWNvbmZpZy5kaXNhYmxlRXNsaW50SWdub3JlLFxuICAgIHdhcm5JZ25vcmVkOiBmYWxzZSxcbiAgICBmaXg6IHR5cGUgPT09ICdmaXgnXG4gIH1cblxuICBjb25zdCBpZ25vcmVGaWxlID0gY29uZmlnLmRpc2FibGVFc2xpbnRJZ25vcmUgPyBudWxsIDogZmluZENhY2hlZChmaWxlRGlyLCAnLmVzbGludGlnbm9yZScpXG4gIGlmIChpZ25vcmVGaWxlKSB7XG4gICAgY2xpRW5naW5lQ29uZmlnLmlnbm9yZVBhdGggPSBpZ25vcmVGaWxlXG4gIH1cblxuICBpZiAoY29uZmlnLmVzbGludFJ1bGVzRGlyKSB7XG4gICAgbGV0IHJ1bGVzRGlyID0gcmVzb2x2ZUVudihjb25maWcuZXNsaW50UnVsZXNEaXIpXG4gICAgaWYgKCFQYXRoLmlzQWJzb2x1dGUocnVsZXNEaXIpKSB7XG4gICAgICBydWxlc0RpciA9IGZpbmRDYWNoZWQoZmlsZURpciwgcnVsZXNEaXIpXG4gICAgfVxuICAgIGlmIChydWxlc0Rpcikge1xuICAgICAgY2xpRW5naW5lQ29uZmlnLnJ1bGVQYXRocyA9IFtydWxlc0Rpcl1cbiAgICB9XG4gIH1cblxuICBpZiAoZ2l2ZW5Db25maWdQYXRoID09PSBudWxsICYmIGNvbmZpZy5lc2xpbnRyY1BhdGgpIHtcbiAgICAvLyBJZiB3ZSBkaWRuJ3QgZmluZCBhIGNvbmZpZ3VyYXRpb24gdXNlIHRoZSBmYWxsYmFjayBmcm9tIHRoZSBzZXR0aW5nc1xuICAgIGNsaUVuZ2luZUNvbmZpZy5jb25maWdGaWxlID0gcmVzb2x2ZUVudihjb25maWcuZXNsaW50cmNQYXRoKVxuICB9XG5cbiAgcmV0dXJuIGNsaUVuZ2luZUNvbmZpZ1xufVxuIl19