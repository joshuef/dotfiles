Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.isValidEditor = isValidEditor;
exports.focusEditor = focusEditor;
exports.replaceTag = replaceTag;
exports.replaceTags = replaceTags;
exports.formatType = formatType;
exports.prepareType = prepareType;
exports.prepareInlineDocs = prepareInlineDocs;
exports.buildDisplayText = buildDisplayText;
exports.buildSnippet = buildSnippet;
exports.extractParams = extractParams;
exports.formatTypeCompletion = formatTypeCompletion;
exports.disposeAll = disposeAll;
exports.openFileAndGoToPosition = openFileAndGoToPosition;
exports.openFileAndGoTo = openFileAndGoTo;
exports.updateTernFile = updateTernFile;
exports.writeFile = writeFile;
exports.isDirectory = isDirectory;
exports.fileExists = fileExists;
exports.getFileContent = getFileContent;
exports.readFile = readFile;
exports.markDefinitionBufferRange = markDefinitionBufferRange;
exports.getPackagePath = getPackagePath;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atomTernjsManager = require('./atom-ternjs-manager');

var _atomTernjsManager2 = _interopRequireDefault(_atomTernjsManager);

var _atomTernjsPackageConfig = require('./atom-ternjs-package-config');

var _atomTernjsPackageConfig2 = _interopRequireDefault(_atomTernjsPackageConfig);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _servicesNavigation = require('./services/navigation');

var _servicesNavigation2 = _interopRequireDefault(_servicesNavigation);

'use babel';

var tags = {

  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;'
};

var grammars = ['JavaScript', 'JavaScript (JSX)', 'Babel ES6 JavaScript', 'Vue Component'];

function isValidEditor(editor) {

  var isTextEditor = atom.workspace.isTextEditor(editor);

  if (!isTextEditor || editor.isMini()) {

    return false;
  }

  var grammar = editor.getGrammar();

  if (!grammars.includes(grammar.name)) {

    return false;
  }

  return true;
}

function focusEditor() {

  var editor = atom.workspace.getActiveTextEditor();

  if (!editor) {

    return;
  }

  var view = atom.views.getView(editor);

  view && view.focus && view.focus();
}

function replaceTag(tag) {

  return tags[tag];
}

function replaceTags(str) {

  if (!str) {

    return '';
  }

  return str.replace(/[&<>]/g, replaceTag);
}

function formatType(data) {

  if (!data.type) {

    return '';
  }

  data.type = data.type.replace(/->/g, ':').replace('<top>', 'window');

  if (!data.exprName) {

    return data.type;
  }

  data.type = data.type.replace(/^fn/, data.exprName);

  return data.type;
}

function prepareType(data) {

  if (!data.type) {

    return;
  }

  return data.type.replace(/->/g, ':').replace('<top>', 'window');
}

function prepareInlineDocs(data) {

  return data.replace(/@param/, '<span class="doc-param-first">@param</span>').replace(/@param/g, '<span class="text-info doc-param">@param</span>').replace(/@return/, '<span class="text-info doc-return">@return</span>');
}

function buildDisplayText(params, name) {

  if (params.length === 0) {

    return name + '()';
  }

  var suggestionParams = params.map(function (param) {

    param = param.replace('}', '\\}');
    param = param.replace(/'"/g, '');

    return param;
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function buildSnippet(params, name) {

  var suggestionParams = params.map(function (param, i) {

    param = param.replace('}', '\\}');

    return '${' + (i + 1) + ':' + param + '}';
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function extractParams(type) {

  if (!type || type.startsWith('fn()')) {

    return [];
  }

  var params = [];
  var start = type.indexOf('(') + 1;
  var inside = 0;

  for (var i = start; i < type.length; i++) {

    if (type[i] === ':' && inside === -1) {

      params.push(type.substring(start, i - 2));

      break;
    }

    if (i === type.length - 1) {

      var param = type.substring(start, i);

      if (param.length) {

        params.push(param);
      }

      break;
    }

    if (type[i] === ',' && inside === 0) {

      params.push(type.substring(start, i));
      start = i + 1;

      continue;
    }

    if (type[i].match(/[{\[\(]/)) {

      inside++;

      continue;
    }

    if (type[i].match(/[}\]\)]/)) {

      inside--;
    }
  }

  return params;
}

function formatTypeCompletion(obj, isProperty, isObjectKey, isInFunDef) {

  if (obj.isKeyword) {

    obj._typeSelf = 'keyword';
  }

  if (obj.type === 'string') {

    obj.name = obj.name ? obj.name.replace(/(^"|"$)/g, '') : null;
  } else {

    obj.name = obj.name ? obj.name.replace(/["']/g, '') : null;
  }

  obj.name = obj.name ? obj.name.replace(/^..?\//, '') : null;

  if (!obj.type) {

    obj._displayText = obj.name;
    obj._snippet = obj.name;

    return obj;
  }

  if (!obj.type.startsWith('fn')) {

    if (isProperty) {

      obj._typeSelf = 'property';
    } else {

      obj._typeSelf = 'variable';
    }
  }

  obj.type = obj.rightLabel = prepareType(obj);

  if (obj.type.replace(/fn\(.+\)/, '').length === 0) {

    obj.leftLabel = '';
  } else {

    if (obj.type.indexOf('fn') === -1) {

      obj.leftLabel = obj.type;
    } else {

      obj.leftLabel = obj.type.replace(/fn\(.{0,}\)/, '').replace(' : ', '');
    }
  }

  if (obj.rightLabel.startsWith('fn')) {

    var params = extractParams(obj.rightLabel);
    var editor = atom.workspace.getActiveTextEditor();
    var cursor = editor.getLastCursor();
    var bufferPosition = cursor.getBufferPosition();
    var bufferPositionFollowing = [bufferPosition.row, bufferPosition.column + 1];
    var charFollowing = editor.getTextInBufferRange([bufferPosition, bufferPositionFollowing]);
    var shouldAddParenthesesToSnippet = charFollowing !== '(';

    if (_atomTernjsPackageConfig2['default'].options.useSnippets || _atomTernjsPackageConfig2['default'].options.useSnippetsAndFunction) {

      if (!isInFunDef) {

        if (params.length === 0) {

          obj._snippet = '' + obj.name + (shouldAddParenthesesToSnippet ? '()' : '');
        } else {

          obj._snippet = buildSnippet(params, obj.name);
        }
      }

      obj._hasParams = params.length ? true : false;
    } else {

      if (!isInFunDef) {

        obj._snippet = params.length ? obj.name + '(${' + 0 + ':${}})' : '' + obj.name + (shouldAddParenthesesToSnippet ? '()' : '');
      }

      obj._displayText = buildDisplayText(params, obj.name);
    }

    obj._typeSelf = 'function';
  }

  if (obj.name) {

    if (obj.leftLabel === obj.name) {

      obj.leftLabel = null;
      obj.rightLabel = null;
    }
  }

  if (obj.leftLabel === obj.rightLabel) {

    obj.rightLabel = null;
  }

  return obj;
}

function disposeAll(disposables) {

  disposables.forEach(function (disposable) {
    return disposable.dispose();
  });
}

function openFileAndGoToPosition(position, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var cursor = textEditor.getLastCursor();

    if (!cursor) {

      return;
    }

    cursor.setBufferPosition(position);
  });
}

function openFileAndGoTo(start, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var buffer = textEditor.getBuffer();
    var cursor = textEditor.getLastCursor();

    if (!buffer || !cursor) {

      return;
    }

    var bufferPosition = buffer.positionForCharacterIndex(start);

    cursor.setBufferPosition(buffer.positionForCharacterIndex(start));

    _servicesNavigation2['default'].append(textEditor, buffer, bufferPosition);

    markDefinitionBufferRange(cursor, textEditor);
  });
}

function updateTernFile(content) {

  var projectRoot = _atomTernjsManager2['default'].server && _atomTernjsManager2['default'].server.projectDir;

  if (!projectRoot) {

    return;
  }

  writeFile(_path2['default'].resolve(__dirname, projectRoot + '/.tern-project'), content);
}

function writeFile(filePath, content) {

  _fs2['default'].writeFile(filePath, content, function (error) {

    atom.workspace.open(filePath);

    if (!error) {

      var server = _atomTernjsManager2['default'].server;
      server && server.restart();

      return;
    }

    var message = 'Could not create/update .tern-project file. Use the README to manually create a .tern-project file.';

    atom.notifications.addInfo(message, {

      dismissable: true
    });
  });
}

function isDirectory(dir) {

  try {

    return _fs2['default'].statSync(dir).isDirectory();
  } catch (error) {

    return false;
  }
}

function fileExists(path) {

  try {

    _fs2['default'].accessSync(path, _fs2['default'].F_OK, function (error) {

      console.error(error);
    });
  } catch (error) {

    return false;
  }
}

function getFileContent(filePath, root) {

  var _filePath = root + filePath;
  var resolvedPath = _path2['default'].resolve(__dirname, _filePath);

  if (fileExists(resolvedPath) !== undefined) {

    return false;
  }

  return readFile(resolvedPath);
}

function readFile(path) {

  try {

    return _fs2['default'].readFileSync(path, 'utf8');
  } catch (err) {

    return undefined;
  }
}

function markDefinitionBufferRange(cursor, editor) {

  var range = cursor.getCurrentWordBufferRange();
  var marker = editor.markBufferRange(range, { invalidate: 'touch' });

  var decoration = editor.decorateMarker(marker, {

    type: 'highlight',
    'class': 'atom-ternjs-definition-marker',
    invalidate: 'touch'
  });

  if (!decoration) {

    return;
  }

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker active',
      invalidate: 'touch'
    });
  }, 1);

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker',
      invalidate: 'touch'
    });
  }, 1501);

  setTimeout(function () {

    marker.destroy();
  }, 2500);
}

function getPackagePath() {

  var packagPath = atom.packages.resolvePackagePath('atom-ternjs');

  return packagPath;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qb3NoL2RvdGZpbGVzL2F0b20vcGFja2FnZXMvYXRvbS10ZXJuanMvbGliL2F0b20tdGVybmpzLWhlbHBlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2lDQUVvQix1QkFBdUI7Ozs7dUNBQ2pCLDhCQUE4Qjs7OztvQkFDdkMsTUFBTTs7OztrQkFDUixJQUFJOzs7O2tDQUNJLHVCQUF1Qjs7OztBQU45QyxXQUFXLENBQUM7O0FBUVosSUFBTSxJQUFJLEdBQUc7O0FBRVgsS0FBRyxFQUFFLE9BQU87QUFDWixLQUFHLEVBQUUsTUFBTTtBQUNYLEtBQUcsRUFBRSxNQUFNO0NBQ1osQ0FBQzs7QUFFRixJQUFNLFFBQVEsR0FBRyxDQUVmLFlBQVksRUFDWixrQkFBa0IsRUFDbEIsc0JBQXNCLEVBQ3RCLGVBQWUsQ0FDaEIsQ0FBQzs7QUFFSyxTQUFTLGFBQWEsQ0FBQyxNQUFNLEVBQUU7O0FBRXBDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUV6RCxNQUFJLENBQUMsWUFBWSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRTs7QUFFcEMsV0FBTyxLQUFLLENBQUM7R0FDZDs7QUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7O0FBRXBDLE1BQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTs7QUFFcEMsV0FBTyxLQUFLLENBQUM7R0FDZDs7QUFFRCxTQUFPLElBQUksQ0FBQztDQUNiOztBQUVNLFNBQVMsV0FBVyxHQUFHOztBQUU1QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELE1BQUksQ0FBQyxNQUFNLEVBQUU7O0FBRVgsV0FBTztHQUNSOztBQUVELE1BQU0sSUFBSSxHQUFHLElB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LEtBQUssR0FBRyxNQUFNLENBQUMseUJBQXlCLEVBQUUsQ0FBQztBQUNqRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxFQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDOztBQUVwRSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRTs7QUFFL0MsUUFBSSxFQUFFLFdBQVc7QUFDakIsYUFBTywrQkFBK0I7QUFDdEMsY0FBVSxFQUFFLE9BQU87R0FDcEIsQ0FBQyxDQUFDOztBQUVILE1BQUksQ0FBQyxVQUFVLEVBQUU7O0FBRWYsV0FBTztHQUNSOztBQUVELFlBQVUsQ0FBQyxZQUFNOztBQUVmLGNBQVUsQ0FBQyxhQUFhLENBQUM7O0FBRXZCLFVBQUksRUFBRSxXQUFXO0FBQ2pCLGVBQU8sc0NBQXNDO0FBQzdDLGdCQUFVLEVBQUUsT0FBTztLQUNwQixDQUFDLENBQUM7R0FFSixFQUFFLENBQUMsQ0FBQyxDQUFDOztBQUVOLFlBQVUsQ0FBQyxZQUFNOztBQUVmLGNBQVUsQ0FBQyxhQUFhLENBQUM7O0FBRXZCLFVBQUksRUFBRSxXQUFXO0FBQ2pCLGVBQU8sK0JBQStCO0FBQ3RDLGdCQUFVLEVBQUUsT0FBTztLQUNwQixDQUFDLENBQUM7R0FFSixFQUFFLElBQUksQ0FBQyxDQUFDOztBQUVULFlBQVUsQ0FBQyxZQUFNOztBQUVmLFVBQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztHQUVsQixFQUFFLElBQUksQ0FBQyxDQUFDO0NBQ1Y7O0FBRU0sU0FBUyxjQUFjLEdBQUc7O0FBRS9CLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUM7O0FBRW5FLFNBQU8sVUFBVSxDQUFDO0NBQ25CIiwiZmlsZSI6Ii9Vc2Vycy9qb3NoL2RvdGZpbGVzL2F0b20vcGFja2FnZXMvYXRvbS10ZXJuanMvbGliL2F0b20tdGVybmpzLWhlbHBlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgbWFuYWdlciBmcm9tICcuL2F0b20tdGVybmpzLW1hbmFnZXInO1xuaW1wb3J0IHBhY2thZ2VDb25maWcgZnJvbSAnLi9hdG9tLXRlcm5qcy1wYWNrYWdlLWNvbmZpZyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgbmF2aWdhdGlvbiBmcm9tICcuL3NlcnZpY2VzL25hdmlnYXRpb24nO1xuXG5jb25zdCB0YWdzID0ge1xuXG4gICcmJzogJyZhbXA7JyxcbiAgJzwnOiAnJmx0OycsXG4gICc+JzogJyZndDsnXG59O1xuXG5jb25zdCBncmFtbWFycyA9IFtcblxuICAnSmF2YVNjcmlwdCcsXG4gICdKYXZhU2NyaXB0IChKU1gpJyxcbiAgJ0JhYmVsIEVTNiBKYXZhU2NyaXB0JyxcbiAgJ1Z1ZSBDb21wb25lbnQnXG5dO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZEVkaXRvcihlZGl0b3IpIHtcblxuICBjb25zdCBpc1RleHRFZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5pc1RleHRFZGl0b3IoZWRpdG9yKTtcblxuICBpZiAoIWlzVGV4dEVkaXRvciB8fCBlZGl0b3IuaXNNaW5pKCkpIHtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IGdyYW1tYXIgPSBlZGl0b3IuZ2V0R3JhbW1hcigpO1xuXG4gIGlmICghZ3JhbW1hcnMuaW5jbHVkZXMoZ3JhbW1hci5uYW1lKSkge1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb2N1c0VkaXRvcigpIHtcblxuICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG5cbiAgaWYgKCFlZGl0b3IpIHtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHZpZXcgPSBhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKTtcblxuICB2aWV3ICYmIHZpZXcuZm9jdXMgJiYgdmlldy5mb2N1cygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZVRhZyh0YWcpIHtcblxuICByZXR1cm4gdGFnc1t0YWddO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVwbGFjZVRhZ3Moc3RyKSB7XG5cbiAgaWYgKCFzdHIpIHtcblxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIHJldHVybiBzdHIucmVwbGFjZSgvWyY8Pl0vZywgcmVwbGFjZVRhZyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRUeXBlKGRhdGEpIHtcblxuICBpZiAoIWRhdGEudHlwZSkge1xuXG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgZGF0YS50eXBlID0gZGF0YS50eXBlLnJlcGxhY2UoLy0+L2csICc6JykucmVwbGFjZSgnPHRvcD4nLCAnd2luZG93Jyk7XG5cbiAgaWYgKCFkYXRhLmV4cHJOYW1lKSB7XG5cbiAgICByZXR1cm4gZGF0YS50eXBlO1xuICB9XG5cbiAgZGF0YS50eXBlID0gZGF0YS50eXBlLnJlcGxhY2UoL15mbi8sIGRhdGEuZXhwck5hbWUpO1xuXG4gIHJldHVybiBkYXRhLnR5cGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwYXJlVHlwZShkYXRhKSB7XG5cbiAgaWYgKCFkYXRhLnR5cGUpIHtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIHJldHVybiBkYXRhLnR5cGUucmVwbGFjZSgvLT4vZywgJzonKS5yZXBsYWNlKCc8dG9wPicsICd3aW5kb3cnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZXBhcmVJbmxpbmVEb2NzKGRhdGEpIHtcblxuICByZXR1cm4gZGF0YVxuICAgIC5yZXBsYWNlKC9AcGFyYW0vLCAnPHNwYW4gY2xhc3M9XCJkb2MtcGFyYW0tZmlyc3RcIj5AcGFyYW08L3NwYW4+JylcbiAgICAucmVwbGFjZSgvQHBhcmFtL2csICc8c3BhbiBjbGFzcz1cInRleHQtaW5mbyBkb2MtcGFyYW1cIj5AcGFyYW08L3NwYW4+JylcbiAgICAucmVwbGFjZSgvQHJldHVybi8sICc8c3BhbiBjbGFzcz1cInRleHQtaW5mbyBkb2MtcmV0dXJuXCI+QHJldHVybjwvc3Bhbj4nKVxuICAgIDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkRGlzcGxheVRleHQocGFyYW1zLCBuYW1lKSB7XG5cbiAgaWYgKHBhcmFtcy5sZW5ndGggPT09IDApIHtcblxuICAgIHJldHVybiBgJHtuYW1lfSgpYDtcbiAgfVxuXG4gIGNvbnN0IHN1Z2dlc3Rpb25QYXJhbXMgPSBwYXJhbXMubWFwKHBhcmFtID0+IHtcblxuICAgIHBhcmFtID0gcGFyYW0ucmVwbGFjZSgnfScsICdcXFxcfScpO1xuICAgIHBhcmFtID0gcGFyYW0ucmVwbGFjZSgvJ1wiL2csICcnKTtcblxuICAgIHJldHVybiBwYXJhbTtcbiAgfSk7XG5cbiAgcmV0dXJuIGAke25hbWV9KCR7c3VnZ2VzdGlvblBhcmFtcy5qb2luKCcsJyl9KWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZFNuaXBwZXQocGFyYW1zLCBuYW1lKSB7XG5cbiAgY29uc3Qgc3VnZ2VzdGlvblBhcmFtcyA9IHBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiB7XG5cbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoJ30nLCAnXFxcXH0nKTtcblxuICAgIHJldHVybiBgXFwkeyR7aSArIDF9OiR7cGFyYW19fWA7XG4gIH0pO1xuXG4gIHJldHVybiBgJHtuYW1lfSgke3N1Z2dlc3Rpb25QYXJhbXMuam9pbignLCcpfSlgO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdFBhcmFtcyh0eXBlKSB7XG5cbiAgaWYgKCF0eXBlIHx8IHR5cGUuc3RhcnRzV2l0aCgnZm4oKScpKSB7XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBwYXJhbXMgPSBbXTtcbiAgbGV0IHN0YXJ0ID0gdHlwZS5pbmRleE9mKCcoJykgKyAxO1xuICBsZXQgaW5zaWRlID0gMDtcblxuICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCB0eXBlLmxlbmd0aDsgaSsrKSB7XG5cbiAgICBpZiAodHlwZVtpXSA9PT0gJzonICYmIGluc2lkZSA9PT0gLTEpIHtcblxuICAgICAgcGFyYW1zLnB1c2godHlwZS5zdWJzdHJpbmcoc3RhcnQsIGkgLSAyKSk7XG5cbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChpID09PSB0eXBlLmxlbmd0aCAtIDEpIHtcblxuICAgICAgY29uc3QgcGFyYW0gPSB0eXBlLnN1YnN0cmluZyhzdGFydCwgaSk7XG5cbiAgICAgIGlmIChwYXJhbS5sZW5ndGgpIHtcblxuICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7XG4gICAgICB9XG5cbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGlmICh0eXBlW2ldID09PSAnLCcgJiYgaW5zaWRlID09PSAwKSB7XG5cbiAgICAgIHBhcmFtcy5wdXNoKHR5cGUuc3Vic3RyaW5nKHN0YXJ0LCBpKSk7XG4gICAgICBzdGFydCA9IGkgKyAxO1xuXG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAodHlwZVtpXS5tYXRjaCgvW3tcXFtcXChdLykpIHtcblxuICAgICAgaW5zaWRlKys7XG5cbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmICh0eXBlW2ldLm1hdGNoKC9bfVxcXVxcKV0vKSkge1xuXG4gICAgICBpbnNpZGUtLTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcGFyYW1zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0VHlwZUNvbXBsZXRpb24ob2JqLCBpc1Byb3BlcnR5LCBpc09iamVjdEtleSwgaXNJbkZ1bkRlZikge1xuXG4gIGlmIChvYmouaXNLZXl3b3JkKSB7XG5cbiAgICBvYmouX3R5cGVTZWxmID0gJ2tleXdvcmQnO1xuICB9XG5cbiAgaWYgKG9iai50eXBlID09PSAnc3RyaW5nJykge1xuXG4gICAgb2JqLm5hbWUgPSBvYmoubmFtZSA/IG9iai5uYW1lLnJlcGxhY2UoLyheXCJ8XCIkKS9nLCAnJykgOiBudWxsO1xuXG4gIH0gZWxzZSB7XG5cbiAgICBvYmoubmFtZSA9IG9iai5uYW1lID8gb2JqLm5hbWUucmVwbGFjZSgvW1wiJ10vZywgJycpIDogbnVsbDtcbiAgfVxuXG4gIG9iai5uYW1lID0gb2JqLm5hbWUgPyBvYmoubmFtZS5yZXBsYWNlKC9eLi4/XFwvLywgJycpIDogbnVsbDtcblxuICBpZiAoIW9iai50eXBlKSB7XG5cbiAgICBvYmouX2Rpc3BsYXlUZXh0ID0gb2JqLm5hbWU7XG4gICAgb2JqLl9zbmlwcGV0ID0gb2JqLm5hbWU7XG5cbiAgICByZXR1cm4gb2JqO1xuICB9XG5cbiAgaWYgKCFvYmoudHlwZS5zdGFydHNXaXRoKCdmbicpKSB7XG5cbiAgICBpZiAoaXNQcm9wZXJ0eSkge1xuXG4gICAgICBvYmouX3R5cGVTZWxmID0gJ3Byb3BlcnR5JztcblxuICAgIH0gZWxzZSB7XG5cbiAgICAgIG9iai5fdHlwZVNlbGYgPSAndmFyaWFibGUnO1xuICAgIH1cbiAgfVxuXG4gIG9iai50eXBlID0gb2JqLnJpZ2h0TGFiZWwgPSBwcmVwYXJlVHlwZShvYmopO1xuXG4gIGlmIChvYmoudHlwZS5yZXBsYWNlKC9mblxcKC4rXFwpLywgJycpLmxlbmd0aCA9PT0gMCkge1xuXG4gICAgb2JqLmxlZnRMYWJlbCA9ICcnO1xuXG4gIH0gZWxzZSB7XG5cbiAgICBpZiAob2JqLnR5cGUuaW5kZXhPZignZm4nKSA9PT0gLTEpIHtcblxuICAgICAgb2JqLmxlZnRMYWJlbCA9IG9iai50eXBlO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgb2JqLmxlZnRMYWJlbCA9IG9iai50eXBlLnJlcGxhY2UoL2ZuXFwoLnswLH1cXCkvLCAnJykucmVwbGFjZSgnIDogJywgJycpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChvYmoucmlnaHRMYWJlbC5zdGFydHNXaXRoKCdmbicpKSB7XG5cbiAgICBjb25zdCBwYXJhbXMgPSBleHRyYWN0UGFyYW1zKG9iai5yaWdodExhYmVsKTtcbiAgICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG4gICAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldExhc3RDdXJzb3IoKTtcbiAgICBjb25zdCBidWZmZXJQb3NpdGlvbiA9IGN1cnNvci5nZXRCdWZmZXJQb3NpdGlvbigpO1xuICAgIGNvbnN0IGJ1ZmZlclBvc2l0aW9uRm9sbG93aW5nID0gW2J1ZmZlclBvc2l0aW9uLnJvdywgYnVmZmVyUG9zaXRpb24uY29sdW1uICsgMV07XG4gICAgY29uc3QgY2hhckZvbGxvd2luZyA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShbYnVmZmVyUG9zaXRpb24sIGJ1ZmZlclBvc2l0aW9uRm9sbG93aW5nXSk7XG4gICAgY29uc3Qgc2hvdWxkQWRkUGFyZW50aGVzZXNUb1NuaXBwZXQgPSBjaGFyRm9sbG93aW5nICE9PSAnKCc7XG5cbiAgICBpZiAoXG4gICAgICBwYWNrYWdlQ29uZmlnLm9wdGlvbnMudXNlU25pcHBldHMgfHxcbiAgICAgIHBhY2thZ2VDb25maWcub3B0aW9ucy51c2VTbmlwcGV0c0FuZEZ1bmN0aW9uXG4gICAgKSB7XG5cbiAgICAgIGlmICghaXNJbkZ1bkRlZikge1xuXG4gICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID09PSAwKSB7XG5cbiAgICAgICAgICBvYmouX3NuaXBwZXQgPSBgJHtvYmoubmFtZX0ke3Nob3VsZEFkZFBhcmVudGhlc2VzVG9TbmlwcGV0ID8gJygpJyA6ICcnfWA7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgIG9iai5fc25pcHBldCA9IGJ1aWxkU25pcHBldChwYXJhbXMsIG9iai5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBvYmouX2hhc1BhcmFtcyA9IHBhcmFtcy5sZW5ndGggPyB0cnVlIDogZmFsc2U7XG5cbiAgICB9IGVsc2Uge1xuXG4gICAgICBpZiAoIWlzSW5GdW5EZWYpIHtcblxuICAgICAgICBvYmouX3NuaXBwZXQgPSBwYXJhbXMubGVuZ3RoID8gYCR7b2JqLm5hbWV9KFxcJHskezB9OlxcJHt9fSlgIDogYCR7b2JqLm5hbWV9JHtzaG91bGRBZGRQYXJlbnRoZXNlc1RvU25pcHBldCA/ICcoKScgOiAnJ31gO1xuICAgICAgfVxuXG4gICAgICBvYmouX2Rpc3BsYXlUZXh0ID0gYnVpbGREaXNwbGF5VGV4dChwYXJhbXMsIG9iai5uYW1lKTtcbiAgICB9XG5cbiAgICBvYmouX3R5cGVTZWxmID0gJ2Z1bmN0aW9uJztcbiAgfVxuXG4gIGlmIChvYmoubmFtZSkge1xuXG4gICAgaWYgKG9iai5sZWZ0TGFiZWwgPT09IG9iai5uYW1lKSB7XG5cbiAgICAgIG9iai5sZWZ0TGFiZWwgPSBudWxsO1xuICAgICAgb2JqLnJpZ2h0TGFiZWwgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGlmIChvYmoubGVmdExhYmVsID09PSBvYmoucmlnaHRMYWJlbCkge1xuXG4gICAgb2JqLnJpZ2h0TGFiZWwgPSBudWxsO1xuICB9XG5cbiAgcmV0dXJuIG9iajtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc3Bvc2VBbGwoZGlzcG9zYWJsZXMpIHtcblxuICBkaXNwb3NhYmxlcy5mb3JFYWNoKGRpc3Bvc2FibGUgPT4gZGlzcG9zYWJsZS5kaXNwb3NlKCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb3BlbkZpbGVBbmRHb1RvUG9zaXRpb24ocG9zaXRpb24sIGZpbGUpIHtcblxuICBhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGUpLnRoZW4oKHRleHRFZGl0b3IpID0+IHtcblxuICAgIGNvbnN0IGN1cnNvciA9IHRleHRFZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xuXG4gICAgaWYgKCFjdXJzb3IpIHtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGN1cnNvci5zZXRCdWZmZXJQb3NpdGlvbihwb3NpdGlvbik7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb3BlbkZpbGVBbmRHb1RvKHN0YXJ0LCBmaWxlKSB7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub3BlbihmaWxlKS50aGVuKCh0ZXh0RWRpdG9yKSA9PiB7XG5cbiAgICBjb25zdCBidWZmZXIgPSB0ZXh0RWRpdG9yLmdldEJ1ZmZlcigpO1xuICAgIGNvbnN0IGN1cnNvciA9IHRleHRFZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xuXG4gICAgaWYgKFxuICAgICAgIWJ1ZmZlciB8fFxuICAgICAgIWN1cnNvclxuICAgICkge1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYnVmZmVyUG9zaXRpb24gPSBidWZmZXIucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChzdGFydCk7XG5cbiAgICBjdXJzb3Iuc2V0QnVmZmVyUG9zaXRpb24oYnVmZmVyLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoc3RhcnQpKTtcblxuICAgIG5hdmlnYXRpb24uYXBwZW5kKHRleHRFZGl0b3IsIGJ1ZmZlciwgYnVmZmVyUG9zaXRpb24pO1xuXG4gICAgbWFya0RlZmluaXRpb25CdWZmZXJSYW5nZShjdXJzb3IsIHRleHRFZGl0b3IpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVRlcm5GaWxlKGNvbnRlbnQpIHtcblxuICBjb25zdCBwcm9qZWN0Um9vdCA9IG1hbmFnZXIuc2VydmVyICYmIG1hbmFnZXIuc2VydmVyLnByb2plY3REaXI7XG5cbiAgaWYgKCFwcm9qZWN0Um9vdCkge1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgd3JpdGVGaWxlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIHByb2plY3RSb290ICsgJy8udGVybi1wcm9qZWN0JyksIGNvbnRlbnQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gd3JpdGVGaWxlKGZpbGVQYXRoLCBjb250ZW50KSB7XG5cbiAgZnMud3JpdGVGaWxlKGZpbGVQYXRoLCBjb250ZW50LCAoZXJyb3IpID0+IHtcblxuICAgIGF0b20ud29ya3NwYWNlLm9wZW4oZmlsZVBhdGgpO1xuXG4gICAgaWYgKCFlcnJvcikge1xuXG4gICAgICBjb25zdCBzZXJ2ZXIgPSBtYW5hZ2VyLnNlcnZlcjtcbiAgICAgIHNlcnZlciAmJiBzZXJ2ZXIucmVzdGFydCgpO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZSA9ICdDb3VsZCBub3QgY3JlYXRlL3VwZGF0ZSAudGVybi1wcm9qZWN0IGZpbGUuIFVzZSB0aGUgUkVBRE1FIHRvIG1hbnVhbGx5IGNyZWF0ZSBhIC50ZXJuLXByb2plY3QgZmlsZS4nO1xuXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8obWVzc2FnZSwge1xuXG4gICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgIH0pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGlyZWN0b3J5KGRpcikge1xuXG4gIHRyeSB7XG5cbiAgICByZXR1cm4gZnMuc3RhdFN5bmMoZGlyKS5pc0RpcmVjdG9yeSgpO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbGVFeGlzdHMocGF0aCkge1xuXG4gIHRyeSB7XG5cbiAgICBmcy5hY2Nlc3NTeW5jKHBhdGgsIGZzLkZfT0ssIChlcnJvcikgPT4ge1xuXG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlQ29udGVudChmaWxlUGF0aCwgcm9vdCkge1xuXG4gIGNvbnN0IF9maWxlUGF0aCA9IHJvb3QgKyBmaWxlUGF0aDtcbiAgY29uc3QgcmVzb2x2ZWRQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgX2ZpbGVQYXRoKTtcblxuICBpZiAoZmlsZUV4aXN0cyhyZXNvbHZlZFBhdGgpICE9PSB1bmRlZmluZWQpIHtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiByZWFkRmlsZShyZXNvbHZlZFBhdGgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZEZpbGUocGF0aCkge1xuXG4gIHRyeSB7XG5cbiAgICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKHBhdGgsICd1dGY4Jyk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXJrRGVmaW5pdGlvbkJ1ZmZlclJhbmdlKGN1cnNvciwgZWRpdG9yKSB7XG5cbiAgY29uc3QgcmFuZ2UgPSBjdXJzb3IuZ2V0Q3VycmVudFdvcmRCdWZmZXJSYW5nZSgpO1xuICBjb25zdCBtYXJrZXIgPSBlZGl0b3IubWFya0J1ZmZlclJhbmdlKHJhbmdlLCB7aW52YWxpZGF0ZTogJ3RvdWNoJ30pO1xuXG4gIGNvbnN0IGRlY29yYXRpb24gPSBlZGl0b3IuZGVjb3JhdGVNYXJrZXIobWFya2VyLCB7XG5cbiAgICB0eXBlOiAnaGlnaGxpZ2h0JyxcbiAgICBjbGFzczogJ2F0b20tdGVybmpzLWRlZmluaXRpb24tbWFya2VyJyxcbiAgICBpbnZhbGlkYXRlOiAndG91Y2gnXG4gIH0pO1xuXG4gIGlmICghZGVjb3JhdGlvbikge1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICBkZWNvcmF0aW9uLnNldFByb3BlcnRpZXMoe1xuXG4gICAgICB0eXBlOiAnaGlnaGxpZ2h0JyxcbiAgICAgIGNsYXNzOiAnYXRvbS10ZXJuanMtZGVmaW5pdGlvbi1tYXJrZXIgYWN0aXZlJyxcbiAgICAgIGludmFsaWRhdGU6ICd0b3VjaCdcbiAgICB9KTtcblxuICB9LCAxKTtcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgIGRlY29yYXRpb24uc2V0UHJvcGVydGllcyh7XG5cbiAgICAgIHR5cGU6ICdoaWdobGlnaHQnLFxuICAgICAgY2xhc3M6ICdhdG9tLXRlcm5qcy1kZWZpbml0aW9uLW1hcmtlcicsXG4gICAgICBpbnZhbGlkYXRlOiAndG91Y2gnXG4gICAgfSk7XG5cbiAgfSwgMTUwMSk7XG5cbiAgc2V0VGltZW91dCgoKSA9PiB7XG5cbiAgICBtYXJrZXIuZGVzdHJveSgpO1xuXG4gIH0sIDI1MDApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFja2FnZVBhdGgoKSB7XG5cbiAgY29uc3QgcGFja2FnUGF0aCA9IGF0b20ucGFja2FnZXMucmVzb2x2ZVBhY2thZ2VQYXRoKCdhdG9tLXRlcm5qcycpO1xuXG4gIHJldHVybiBwYWNrYWdQYXRoO1xufVxuIl19