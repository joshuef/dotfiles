Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _commandsGenerate = require('./commands/generate');

var _commandsGenerate2 = _interopRequireDefault(_commandsGenerate);

var _commandsShow = require('./commands/show');

var _commandsShow2 = _interopRequireDefault(_commandsShow);

var _commandsFix = require('./commands/fix');

var _commandsFix2 = _interopRequireDefault(_commandsFix);

var importLazy = require('import-lazy').proxy(require);

var atm = importLazy('atom');

var checklist = importLazy('./lib/checklist');
var wrapGuideInterceptor = importLazy('./lib/wrapguide-interceptor');
var statusTile = importLazy('./lib/statustile-view');
var editorconfig = importLazy('editorconfig');

// Sets the state of the embedded editorconfig
// This includes the severity (info, warning..) as well as the notification-messages for users
function setState(ecfg) {
	checklist(ecfg);
	statusTile.updateIcon(ecfg.state);
}

// Initializes the (into the TextBuffer-instance) embedded editorconfig-object
function initializeTextBuffer(buffer) {
	if ('editorconfig' in buffer === false) {
		buffer.editorconfig = {
			buffer: buffer, // Preserving a reference to the parent `TextBuffer`
			disposables: new atm.CompositeDisposable(),
			state: 'subtle',
			settings: {
				trim_trailing_whitespace: 'unset',
				insert_final_newline: 'unset',
				max_line_length: 'unset',
				end_of_line: 'unset',
				indent_style: 'unset',
				tab_width: 'unset',
				charset: 'unset'
			},

			// Get the current Editor for this.buffer
			getCurrentEditor: function getCurrentEditor() {
				var _this = this;

				return atom.workspace.getTextEditors().reduce(function (prev, curr) {
					return curr.getBuffer() === _this.buffer && curr || prev;
				}, undefined);
			},

			// Applies the settings to the buffer and the corresponding editor
			applySettings: function applySettings() {
				var editor = this.getCurrentEditor();
				if (!editor) {
					return;
				}

				var configOptions = { scope: editor.getRootScopeDescriptor() };
				var settings = this.settings;

				if (editor && editor.getBuffer() === buffer) {
					if (settings.indent_style === 'unset') {
						var usesSoftTabs = editor.usesSoftTabs();
						if (usesSoftTabs === undefined) {
							editor.setSoftTabs(atom.config.get('editor.softTabs', configOptions));
						} else {
							editor.setSoftTabs(usesSoftTabs);
						}
					} else {
						editor.setSoftTabs(settings.indent_style === 'space');
					}

					if (settings.tab_width === 'unset') {
						editor.setTabLength(atom.config.get('editor.tabLength', configOptions));
					} else {
						editor.setTabLength(settings.tab_width);
					}

					if (settings.charset === 'unset') {
						buffer.setEncoding(atom.config.get('core.fileEncoding', configOptions));
					} else {
						buffer.setEncoding(settings.charset);
					}

					// Max_line_length-settings
					var editorParams = {};
					if (settings.max_line_length === 'unset') {
						editorParams.preferredLineLength = atom.config.get('editor.preferredLineLength', configOptions);
					} else {
						editorParams.preferredLineLength = settings.max_line_length;
					}

					// Update the editor-properties
					editor.update(editorParams);

					// Ensure the wrap-guide is being intercepted
					var bufferDom = atom.views.getView(editor);
					var wrapGuide = bufferDom.querySelector('* /deep/ .wrap-guide');
					if (wrapGuide !== null) {
						if (wrapGuide.editorconfig === undefined) {
							wrapGuide.editorconfig = this;
							wrapGuide.getNativeGuideColumn = wrapGuide.getGuideColumn;
							wrapGuide.getGuideColumn = wrapGuideInterceptor.getGuideColumn.bind(wrapGuide);
							wrapGuide.getNativeGuidesColumns = wrapGuide.getGuidesColumns;
							wrapGuide.getGuidesColumns = wrapGuideInterceptor.getGuidesColumns.bind(wrapGuide);
						}

						if (typeof wrapGuide.updateGuide === 'function') {
							wrapGuide.updateGuide();
						} else {
							// NB: This won't work with multiple wrap-guides
							var columnWidth = bufferDom.getDefaultCharacterWidth() * editorParams.preferredLineLength;
							if (columnWidth > 0) {
								wrapGuide.style.left = Math.round(columnWidth) + 'px';
								wrapGuide.style.display = 'block';
							} else {
								wrapGuide.style.display = 'none';
							}
						}
					}

					if (settings.end_of_line !== 'unset') {
						buffer.setPreferredLineEnding(settings.end_of_line);
					}
				}

				setState(this);
			},

			// `onWillSave` event handler
			// Trims whitespaces and inserts/strips final newline before saving
			onWillSave: function onWillSave() {
				var settings = this.settings;

				if (settings.trim_trailing_whitespace === true) {
					buffer.backwardsScan(/[ \t]+$/gm, function (params) {
						if (params.match[0].length > 0) {
							params.replace('');
						}
					});
				}

				if (settings.insert_final_newline !== 'unset') {
					var lastRow = buffer.getLineCount() - 1;

					if (buffer.isRowBlank(lastRow)) {
						var stripStart = buffer.previousNonBlankRow(lastRow);

						if (settings.insert_final_newline === true) {
							stripStart += 1;
						}

						// Strip empty lines from the end
						if (stripStart < lastRow) {
							buffer.deleteRows(stripStart + 1, lastRow);
						}
					} else if (settings.insert_final_newline === true) {
						buffer.append('\n');
					}
				}
			}
		};

		buffer.editorconfig.disposables.add(buffer.onWillSave(buffer.editorconfig.onWillSave.bind(buffer.editorconfig)));

		if (buffer.getUri() && buffer.getUri().match(/[\\|/]\.editorconfig$/g) !== null) {
			buffer.editorconfig.disposables.add(buffer.onDidSave(reapplyEditorconfig));
		}
	}
}

// Reveal and apply the editorconfig for the given TextEditor-instance
function observeTextEditor(editor) {
	if (!editor) {
		return;
	}

	initializeTextBuffer(editor.getBuffer());

	var file = editor.getURI();
	if (!file) {
		editor.onDidSave(function () {
			observeTextEditor(editor);
		});
		return;
	}

	editorconfig.parse(file).then(function (config) {
		if (Object.keys(config).length === 0) {
			return;
		}

		var ecfg = editor.getBuffer().editorconfig;
		var settings = ecfg.settings;

		var lineEndings = {
			crlf: '\r\n',
			cr: '\r',
			lf: '\n'
		};

		// Preserve evaluated Editorconfig
		ecfg.config = config;

		// Carefully normalize and initialize config-settings
		settings.trim_trailing_whitespace = 'trim_trailing_whitespace' in config && typeof config.trim_trailing_whitespace === 'boolean' ? config.trim_trailing_whitespace === true : 'unset';

		settings.insert_final_newline = 'insert_final_newline' in config && typeof config.insert_final_newline === 'boolean' ? config.insert_final_newline === true : 'unset';

		settings.indent_style = 'indent_style' in config && config.indent_style.search(/^(space|tab)$/) > -1 ? config.indent_style : 'unset';

		settings.end_of_line = lineEndings[config.end_of_line] || 'unset';

		settings.tab_width = parseInt(config.indent_size || config.tab_width, 10);
		if (isNaN(settings.tab_width) || settings.tab_width <= 0) {
			settings.tab_width = 'unset';
		}

		settings.max_line_length = parseInt(config.max_line_length, 10);
		if (isNaN(settings.max_line_length) || settings.max_line_length <= 0) {
			settings.max_line_length = 'unset';
		}

		settings.charset = 'charset' in config ? config.charset.replace(/-/g, '').toLowerCase() : 'unset';

		// #227: Allow `latin1` as an alias of ISO 8859-1.
		if (String(settings.charset).toLowerCase().replace(/\W/g, '') === 'latin1') {
			settings.charset = 'iso88591';
		}

		ecfg.applySettings();
	})['catch'](function (error) {
		console.warn('atom-editorconfig: ' + error);
	});
}

// Reapplies the whole editorconfig to **all** open TextEditor-instances
function reapplyEditorconfig() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		observeTextEditor(editor);
	});
}

// Reapplies the settings immediately after changing the focus to a new pane
function observeActivePaneItem(editor) {
	if (editor && editor.constructor.name === 'TextEditor') {
		if (editor.buffer && editor.buffer.editorconfig) {
			editor.buffer.editorconfig.applySettings();
		}
	} else {
		statusTile.removeIcon();
	}
}

// Hook into the events to recognize the user opening new editors or changing the pane
var activate = function activate() {
	(0, _commandsGenerate2['default'])();
	(0, _commandsShow2['default'])();
	(0, _commandsFix2['default'])();
	atom.workspace.observeTextEditors(observeTextEditor);
	atom.workspace.observeActivePaneItem(observeActivePaneItem);
	reapplyEditorconfig();

	// #220: Fix spurious "thrashing" in open editors at startup
	if (!atom.packages.hasActivatedInitialPackages()) {
		(function () {
			var disposables = new atm.CompositeDisposable();
			disposables.add(atom.packages.onDidActivatePackage(function (pkg) {
				if (pkg.name === 'whitespace' || pkg.name === 'wrap-guide') {
					reapplyEditorconfig();
				}
			}), atom.packages.onDidActivateInitialPackages(function () {
				disposables.dispose();
				reapplyEditorconfig();
			}));
		})();
	}
};

// Clean the status-icon up, remove all embedded editorconfig-objects
var deactivate = function deactivate() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		editor.getBuffer().editorconfig.disposables.dispose();
	});
	statusTile.removeIcon();
};

// Apply the statusbar icon-container
// The icon will be applied if needed
var consumeStatusBar = function consumeStatusBar(statusBar) {
	if (statusTile.containerExists() === false) {
		statusBar.addRightTile({
			item: statusTile.createContainer(),
			priority: 999
		});
	}
};

exports['default'] = { activate: activate, deactivate: deactivate, consumeStatusBar: consumeStatusBar };
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9qb3NoL2RvdGZpbGVzL2F0b20vcGFja2FnZXMvZWRpdG9yY29uZmlnL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O2dDQUMyQixxQkFBcUI7Ozs7NEJBQzFCLGlCQUFpQjs7OzsyQkFDbkIsZ0JBQWdCOzs7O0FBRXBDLElBQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRXpELElBQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQzs7QUFFL0IsSUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDaEQsSUFBTSxvQkFBb0IsR0FBRyxVQUFVLENBQUMsNkJBQTZCLENBQUMsQ0FBQztBQUN2RSxJQUFNLFVBQVUsR0FBRyxVQUFVLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUN2RCxJQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7Ozs7QUFJaEQsU0FBUyxRQUFRLENBQUMsSUFBSSxFQUFFO0FBQ3ZCLFVBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNoQixXQUFVLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUNsQzs7O0FBR0QsU0FBUyxvQkFBb0IsQ0FBQyxNQUFNLEVBQUU7QUFDckMsS0FBSSxjQUFjLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRTtBQUN2QyxRQUFNLENBQUMsWUFBWSxHQUFHO0FBQ3JCLFNBQU0sRUFBTixNQUFNO0FBQ04sY0FBVyxFQUFFLElBQUssR0FBRyxDQUFDLG1CQUFtQixFQUFHO0FBQzVDLFFBQUssRUFBRSxRQUFRO0FBQ2YsV0FBUSxFQUFFO0FBQ1QsNEJBQXdCLEVBQUUsT0FBTztBQUNqQyx3QkFBb0IsRUFBRSxPQUFPO0FBQzdCLG1CQUFlLEVBQUUsT0FBTztBQUN4QixlQUFXLEVBQUUsT0FBTztBQUNwQixnQkFBWSxF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Qzs7cUJBRWEsRUFBQyxRQUFRLEVBQVIsUUFBUSxFQUFFLFVBQVUsRUFBVixVQUFVLEVBQUUsZ0JBQWdCLEVBQWhCLGdCQUFnQixFQUFDIiwiZmlsZSI6Ii9Vc2Vycy9qb3NoL2RvdGZpbGVzL2F0b20vcGFja2FnZXMvZWRpdG9yY29uZmlnL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqIEBiYWJlbCAqL1xuaW1wb3J0IGdlbmVyYXRlQ29uZmlnIGZyb20gJy4vY29tbWFuZHMvZ2VuZXJhdGUnO1xuaW1wb3J0IHNob3dTdGF0ZSBmcm9tICcuL2NvbW1hbmRzL3Nob3cnO1xuaW1wb3J0IGZpeEZpbGUgZnJvbSAnLi9jb21tYW5kcy9maXgnO1xuXG5jb25zdCBpbXBvcnRMYXp5ID0gcmVxdWlyZSgnaW1wb3J0LWxhenknKS5wcm94eShyZXF1aXJlKTtcblxuY29uc3QgYXRtID0gaW1wb3J0TGF6eSgnYXRvbScpO1xuXG5jb25zdCBjaGVja2xpc3QgPSBpbXBvcnRMYXp5KCcuL2xpYi9jaGVja2xpc3QnKTtcbmNvbnN0IHdyYXBHdWlkZUludGVyY2VwdG9yID0gaW1wb3J0TGF6eSgnLi9saWIvd3JhcGd1aWRlLWludGVyY2VwdG9yJyk7XG5jb25zdCBzdGF0dXNUaWxlID0gaW1wb3J0TGF6eSgnLi9saWIvc3RhdHVzdGlsZS12aWV3Jyk7XG5jb25zdCBlZGl0b3Jjb25maWcgPSBpbXBvcnRMYXp5KCdlZGl0b3Jjb25maWcnKTtcblxuLy8gU2V0cyB0aGUgc3RhdGUgb2YgdGhlIGVtYmVkZGVkIGVkaXRvcmNvbmZpZ1xuLy8gVGhpcyBpbmNsdWRlcyB0aGUgc2V2ZXJpdHkgKGluZm8sIHdhcm5pbmcuLikgYXMgd2VsbCBhcyB0aGUgbm90aWZpY2F0aW9uLW1lc3NhZ2VzIGZvciB1c2Vyc1xuZnVuY3Rpb24gc2V0U3RhdGUoZWNmZykge1xuXHRjaGVja2xpc3QoZWNmZyk7XG5cdHN0YXR1c1RpbGUudXBkYXRlSWNvbihlY2ZnLnN0YXRlKTtcbn1cblxuLy8gSW5pdGlhbGl6ZXMgdGhlIChpbnRvIHRoZSBUZXh0QnVmZmVyLWluc3RhbmNlKSBlbWJlZGRlZCBlZGl0b3Jjb25maWctb2JqZWN0XG5mdW5jdGlvbiBpbml0aWFsaXplVGV4dEJ1ZmZlcihidWZmZXIpIHtcblx0aWYgKCdlZGl0b3Jjb25maWcnIGluIGJ1ZmZlciA9PT0gZmFsc2UpIHtcblx0XHRidWZmZXIuZWRpdG9yY29uZmlnID0ge1xuXHRcdFx0YnVmZmVyLCAvLyBQcmVzZXJ2aW5nIGEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgYFRleHRCdWZmZXJgXG5cdFx0XHRkaXNwb3NhYmxlczogbmV3IChhdG0uQ29tcG9zaXRlRGlzcG9zYWJsZSkoKSxcblx0XHRcdHN0YXRlOiAnc3VidGxlJyxcblx0XHRcdHNldHRpbmdzOiB7XG5cdFx0XHRcdHRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZTogJ3Vuc2V0Jyxcblx0XHRcdFx0aW5zZXJ0X2ZpbmFsX25ld2xpbmU6ICd1bnNldCcsXG5cdFx0XHRcdG1heF9saW5lX2xlbmd0aDogJ3Vuc2V0Jyxcblx0XHRcdFx0ZW5kX29mX2xpbmU6ICd1bnNldCcsXG5cdFx0XHRcdGluZGVudF9zdHlsZTogJ3Vuc2V0Jyxcblx0XHRcdFx0dGFiX3dpZHRoOiAndW5zZXQnLFxuXHRcdFx0XHRjaGFyc2V0OiAndW5zZXQnXG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBHZXQgdGhlIGN1cnJlbnQgRWRpdG9yIGZvciB0aGlzLmJ1ZmZlclxuXHRcdFx0Z2V0Q3VycmVudEVkaXRvcigpIHtcblx0XHRcdFx0cmV0dXJuIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkucmVkdWNlKChwcmV2LCBjdXJyKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIChjdXJyLmdldEJ1ZmZlcigpID09PSB0aGlzLmJ1ZmZlciAmJiBjdXJyKSB8fCBwcmV2O1xuXHRcdFx0XHR9LCB1bmRlZmluZWQpO1xuXHRcdFx0fSxcblxuXHRcdFx0Ly8gQXBwbGllcyB0aGUgc2V0dGluZ3MgdG8gdGhlIGJ1ZmZlciBhbmQgdGhlIGNvcnJlc3BvbmRpbmcgZWRpdG9yXG5cdFx0XHRhcHBseVNldHRpbmdzKCkge1xuXHRcdFx0XHRjb25zdCBlZGl0b3IgPSB0aGlzLmdldEN1cnJlbnRFZGl0b3IoKTtcblx0XHRcdFx0aWYgKCFlZGl0b3IpIHtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBjb25maWdPcHRpb25zID0ge3Njb3BlOiBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpfTtcblx0XHRcdFx0Y29uc3Qge3NldHRpbmdzfSA9IHRoaXM7XG5cblx0XHRcdFx0aWYgKGVkaXRvciAmJiBlZGl0b3IuZ2V0QnVmZmVyKCkgPT09IGJ1ZmZlcikge1xuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5pbmRlbnRfc3R5bGUgPT09ICd1bnNldCcpIHtcblx0XHRcdFx0XHRcdGNvbnN0IHVzZXNTb2Z0VGFicyA9IGVkaXRvci51c2VzU29mdFRhYnMoKTtcblx0XHRcdFx0XHRcdGlmICh1c2VzU29mdFRhYnMgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XHRlZGl0b3Iuc2V0U29mdFRhYnMoYXRvbS5jb25maWcuZ2V0KCdlZGl0b3Iuc29mdFRhYnMnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRlZGl0b3Iuc2V0U29mdFRhYnModXNlc1NvZnRUYWJzKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnNldFNvZnRUYWJzKHNldHRpbmdzLmluZGVudF9zdHlsZSA9PT0gJ3NwYWNlJyk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLnRhYl93aWR0aCA9PT0gJ3Vuc2V0Jykge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnNldFRhYkxlbmd0aChhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci50YWJMZW5ndGgnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGVkaXRvci5zZXRUYWJMZW5ndGgoc2V0dGluZ3MudGFiX3dpZHRoKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MuY2hhcnNldCA9PT0gJ3Vuc2V0Jykge1xuXHRcdFx0XHRcdFx0YnVmZmVyLnNldEVuY29kaW5nKGF0b20uY29uZmlnLmdldCgnY29yZS5maWxlRW5jb2RpbmcnLCBjb25maWdPcHRpb25zKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGJ1ZmZlci5zZXRFbmNvZGluZyhzZXR0aW5ncy5jaGFyc2V0KTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHQvLyBNYXhfbGluZV9sZW5ndGgtc2V0dGluZ3Ncblx0XHRcdFx0XHRjb25zdCBlZGl0b3JQYXJhbXMgPSB7fTtcblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID09PSAndW5zZXQnKSB7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMucHJlZmVycmVkTGluZUxlbmd0aCA9XG5cdFx0XHRcdFx0XHRcdGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnByZWZlcnJlZExpbmVMZW5ndGgnLCBjb25maWdPcHRpb25zKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWRpdG9yUGFyYW1zLnByZWZlcnJlZExpbmVMZW5ndGggPSBzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGg7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ly8gVXBkYXRlIHRoZSBlZGl0b3ItcHJvcGVydGllc1xuXHRcdFx0XHRcdGVkaXRvci51cGRhdGUoZWRpdG9yUGFyYW1zKTtcblxuXHRcdFx0XHRcdC8vIEVuc3VyZSB0aGUgd3JhcC1ndWlkZSBpcyBiZWluZyBpbnRlcmNlcHRlZFxuXHRcdFx0XHRcdGNvbnN0IGJ1ZmZlckRvbSA9IGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpO1xuXHRcdFx0XHRcdGNvbnN0IHdyYXBHdWlkZSA9IGJ1ZmZlckRvbS5xdWVyeVNlbGVjdG9yKCcqIC9kZWVwLyAud3JhcC1ndWlkZScpO1xuXHRcdFx0XHRcdGlmICh3cmFwR3VpZGUgIT09IG51bGwpIHtcblx0XHRcdFx0XHRcdGlmICh3cmFwR3VpZGUuZWRpdG9yY29uZmlnID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0d3JhcEd1aWRlLmVkaXRvcmNvbmZpZyA9IHRoaXM7XG5cdFx0XHRcdFx0XHRcdHdyYXBHdWlkZS5nZXROYXRpdmVHdWlkZUNvbHVtbiA9IHdyYXBHdWlkZS5nZXRHdWlkZUNvbHVtbjtcblx0XHRcdFx0XHRcdFx0d3JhcEd1aWRlLmdldEd1aWRlQ29sdW1uID0gd3JhcEd1aWRlSW50ZXJjZXB0b3IuZ2V0R3VpZGVDb2x1bW4uYmluZCh3cmFwR3VpZGUpO1xuXHRcdFx0XHRcdFx0XHR3cmFwR3VpZGUuZ2V0TmF0aXZlR3VpZGVzQ29sdW1ucyA9IHdyYXBHdWlkZS5nZXRHdWlkZXNDb2x1bW5zO1xuXHRcdFx0XHRcdFx0XHR3cmFwR3VpZGUuZ2V0R3VpZGVzQ29sdW1ucyA9IHdyYXBHdWlkZUludGVyY2VwdG9yLmdldEd1aWRlc0NvbHVtbnMuYmluZCh3cmFwR3VpZGUpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZiAodHlwZW9mIHdyYXBHdWlkZS51cGRhdGVHdWlkZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRcdFx0XHR3cmFwR3VpZGUudXBkYXRlR3VpZGUoKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdC8vIE5COiBUaGlzIHdvbid0IHdvcmsgd2l0aCBtdWx0aXBsZSB3cmFwLWd1aWRlc1xuXHRcdFx0XHRcdFx0XHRjb25zdCBjb2x1bW5XaWR0aCA9IGJ1ZmZlckRvbS5nZXREZWZhdWx0Q2hhcmFjdGVyV2lkdGgoKSAqIGVkaXRvclBhcmFtcy5wcmVmZXJyZWRMaW5lTGVuZ3RoO1xuXHRcdFx0XHRcdFx0XHRpZiAoY29sdW1uV2lkdGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdFx0d3JhcEd1aWRlLnN0eWxlLmxlZnQgPSBNYXRoLnJvdW5kKGNvbHVtbldpZHRoKSArICdweCc7XG5cdFx0XHRcdFx0XHRcdFx0d3JhcEd1aWRlLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdHdyYXBHdWlkZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLmVuZF9vZl9saW5lICE9PSAndW5zZXQnKSB7XG5cdFx0XHRcdFx0XHRidWZmZXIuc2V0UHJlZmVycmVkTGluZUVuZGluZyhzZXR0aW5ncy5lbmRfb2ZfbGluZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0c2V0U3RhdGUodGhpcyk7XG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBgb25XaWxsU2F2ZWAgZXZlbnQgaGFuZGxlclxuXHRcdFx0Ly8gVHJpbXMgd2hpdGVzcGFjZXMgYW5kIGluc2VydHMvc3RyaXBzIGZpbmFsIG5ld2xpbmUgYmVmb3JlIHNhdmluZ1xuXHRcdFx0b25XaWxsU2F2ZSgpIHtcblx0XHRcdFx0Y29uc3Qge3NldHRpbmdzfSA9IHRoaXM7XG5cblx0XHRcdFx0aWYgKHNldHRpbmdzLnRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdGJ1ZmZlci5iYWNrd2FyZHNTY2FuKC9bIFxcdF0rJC9nbSwgcGFyYW1zID0+IHtcblx0XHRcdFx0XHRcdGlmIChwYXJhbXMubWF0Y2hbMF0ubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0XHRwYXJhbXMucmVwbGFjZSgnJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoc2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgIT09ICd1bnNldCcpIHtcblx0XHRcdFx0XHRjb25zdCBsYXN0Um93ID0gYnVmZmVyLmdldExpbmVDb3VudCgpIC0gMTtcblxuXHRcdFx0XHRcdGlmIChidWZmZXIuaXNSb3dCbGFuayhsYXN0Um93KSkge1xuXHRcdFx0XHRcdFx0bGV0IHN0cmlwU3RhcnQgPSBidWZmZXIucHJldmlvdXNOb25CbGFua1JvdyhsYXN0Um93KTtcblxuXHRcdFx0XHRcdFx0aWYgKHNldHRpbmdzLmluc2VydF9maW5hbF9uZXdsaW5lID09PSB0cnVlKSB7XG5cdFx0XHRcdFx0XHRcdHN0cmlwU3RhcnQgKz0gMTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Ly8gU3RyaXAgZW1wdHkgbGluZXMgZnJvbSB0aGUgZW5kXG5cdFx0XHRcdFx0XHRpZiAoc3RyaXBTdGFydCA8IGxhc3RSb3cpIHtcblx0XHRcdFx0XHRcdFx0YnVmZmVyLmRlbGV0ZVJvd3Moc3RyaXBTdGFydCArIDEsIGxhc3RSb3cpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSBpZiAoc2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdGJ1ZmZlci5hcHBlbmQoJ1xcbicpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH07XG5cblx0XHRidWZmZXIuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmFkZChcblx0XHRcdGJ1ZmZlci5vbldpbGxTYXZlKGJ1ZmZlci5lZGl0b3Jjb25maWcub25XaWxsU2F2ZS5iaW5kKGJ1ZmZlci5lZGl0b3Jjb25maWcpKVxuXHRcdCk7XG5cblx0XHRpZiAoYnVmZmVyLmdldFVyaSgpICYmIGJ1ZmZlci5nZXRVcmkoKS5tYXRjaCgvW1xcXFx8L11cXC5lZGl0b3Jjb25maWckL2cpICE9PSBudWxsKSB7XG5cdFx0XHRidWZmZXIuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmFkZChcblx0XHRcdFx0YnVmZmVyLm9uRGlkU2F2ZShyZWFwcGx5RWRpdG9yY29uZmlnKVxuXHRcdFx0KTtcblx0XHR9XG5cdH1cbn1cblxuLy8gUmV2ZWFsIGFuZCBhcHBseSB0aGUgZWRpdG9yY29uZmlnIGZvciB0aGUgZ2l2ZW4gVGV4dEVkaXRvci1pbnN0YW5jZVxuZnVuY3Rpb24gb2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKSB7XG5cdGlmICghZWRpdG9yKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0aW5pdGlhbGl6ZVRleHRCdWZmZXIoZWRpdG9yLmdldEJ1ZmZlcigpKTtcblxuXHRjb25zdCBmaWxlID0gZWRpdG9yLmdldFVSSSgpO1xuXHRpZiAoIWZpbGUpIHtcblx0XHRlZGl0b3Iub25EaWRTYXZlKCgpID0+IHtcblx0XHRcdG9ic2VydmVUZXh0RWRpdG9yKGVkaXRvcik7XG5cdFx0fSk7XG5cdFx0cmV0dXJuO1xuXHR9XG5cblx0ZWRpdG9yY29uZmlnLnBhcnNlKGZpbGUpLnRoZW4oY29uZmlnID0+IHtcblx0XHRpZiAoT2JqZWN0LmtleXMoY29uZmlnKS5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBlY2ZnID0gZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZztcblx0XHRjb25zdCB7c2V0dGluZ3N9ID0gZWNmZztcblx0XHRjb25zdCBsaW5lRW5kaW5ncyA9IHtcblx0XHRcdGNybGY6ICdcXHJcXG4nLFxuXHRcdFx0Y3I6ICdcXHInLFxuXHRcdFx0bGY6ICdcXG4nXG5cdFx0fTtcblxuXHRcdC8vIFByZXNlcnZlIGV2YWx1YXRlZCBFZGl0b3Jjb25maWdcblx0XHRlY2ZnLmNvbmZpZyA9IGNvbmZpZztcblxuXHRcdC8vIENhcmVmdWxseSBub3JtYWxpemUgYW5kIGluaXRpYWxpemUgY29uZmlnLXNldHRpbmdzXG5cdFx0c2V0dGluZ3MudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID0gKCd0cmltX3RyYWlsaW5nX3doaXRlc3BhY2UnIGluIGNvbmZpZykgJiZcblx0XHRcdHR5cGVvZiBjb25maWcudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID09PSAnYm9vbGVhbicgP1xuXHRcdFx0Y29uZmlnLnRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSA9PT0gdHJ1ZSA6XG5cdFx0XHQndW5zZXQnO1xuXG5cdFx0c2V0dGluZ3MuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPSAoJ2luc2VydF9maW5hbF9uZXdsaW5lJyBpbiBjb25maWcpICYmXG5cdFx0XHR0eXBlb2YgY29uZmlnLmluc2VydF9maW5hbF9uZXdsaW5lID09PSAnYm9vbGVhbicgP1xuXHRcdFx0Y29uZmlnLmluc2VydF9maW5hbF9uZXdsaW5lID09PSB0cnVlIDpcblx0XHRcdCd1bnNldCc7XG5cblx0XHRzZXR0aW5ncy5pbmRlbnRfc3R5bGUgPSAoKCdpbmRlbnRfc3R5bGUnIGluIGNvbmZpZykgJiZcblx0XHRcdGNvbmZpZy5pbmRlbnRfc3R5bGUuc2VhcmNoKC9eKHNwYWNlfHRhYikkLykgPiAtMSkgP1xuXHRcdFx0Y29uZmlnLmluZGVudF9zdHlsZSA6XG5cdFx0XHQndW5zZXQnO1xuXG5cdFx0c2V0dGluZ3MuZW5kX29mX2xpbmUgPSBsaW5lRW5kaW5nc1tjb25maWcuZW5kX29mX2xpbmVdIHx8ICd1bnNldCc7XG5cblx0XHRzZXR0aW5ncy50YWJfd2lkdGggPSBwYXJzZUludChjb25maWcuaW5kZW50X3NpemUgfHwgY29uZmlnLnRhYl93aWR0aCwgMTApO1xuXHRcdGlmIChpc05hTihzZXR0aW5ncy50YWJfd2lkdGgpIHx8IHNldHRpbmdzLnRhYl93aWR0aCA8PSAwKSB7XG5cdFx0XHRzZXR0aW5ncy50YWJfd2lkdGggPSAndW5zZXQnO1xuXHRcdH1cblxuXHRcdHNldHRpbmdzLm1heF9saW5lX2xlbmd0aCA9IHBhcnNlSW50KGNvbmZpZy5tYXhfbGluZV9sZW5ndGgsIDEwKTtcblx0XHRpZiAoaXNOYU4oc2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoKSB8fCBzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGggPD0gMCkge1xuXHRcdFx0c2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID0gJ3Vuc2V0Jztcblx0XHR9XG5cblx0XHRzZXR0aW5ncy5jaGFyc2V0ID0gKCdjaGFyc2V0JyBpbiBjb25maWcpID9cblx0XHRcdGNvbmZpZy5jaGFyc2V0LnJlcGxhY2UoLy0vZywgJycpLnRvTG93ZXJDYXNlKCkgOlxuXHRcdFx0J3Vuc2V0JztcblxuXHRcdC8vICMyMjc6IEFsbG93IGBsYXRpbjFgIGFzIGFuIGFsaWFzIG9mIElTTyA4ODU5LTEuXG5cdFx0aWYgKFN0cmluZyhzZXR0aW5ncy5jaGFyc2V0KS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1xcVy9nLCAnJykgPT09ICdsYXRpbjEnKSB7XG5cdFx0XHRzZXR0aW5ncy5jaGFyc2V0ID0gJ2lzbzg4NTkxJztcblx0XHR9XG5cblx0XHRlY2ZnLmFwcGx5U2V0dGluZ3MoKTtcblx0fSkuY2F0Y2goZXJyb3IgPT4ge1xuXHRcdGNvbnNvbGUud2FybihgYXRvbS1lZGl0b3Jjb25maWc6ICR7ZXJyb3J9YCk7XG5cdH0pO1xufVxuXG4vLyBSZWFwcGxpZXMgdGhlIHdob2xlIGVkaXRvcmNvbmZpZyB0byAqKmFsbCoqIG9wZW4gVGV4dEVkaXRvci1pbnN0YW5jZXNcbmZ1bmN0aW9uIHJlYXBwbHlFZGl0b3Jjb25maWcoKSB7XG5cdGNvbnN0IHRleHRFZGl0b3JzID0gYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKTtcblx0dGV4dEVkaXRvcnMuZm9yRWFjaChlZGl0b3IgPT4ge1xuXHRcdG9ic2VydmVUZXh0RWRpdG9yKGVkaXRvcik7XG5cdH0pO1xufVxuXG4vLyBSZWFwcGxpZXMgdGhlIHNldHRpbmdzIGltbWVkaWF0ZWx5IGFmdGVyIGNoYW5naW5nIHRoZSBmb2N1cyB0byBhIG5ldyBwYW5lXG5mdW5jdGlvbiBvYnNlcnZlQWN0aXZlUGFuZUl0ZW0oZWRpdG9yKSB7XG5cdGlmIChlZGl0b3IgJiYgZWRpdG9yLmNvbnN0cnVjdG9yLm5hbWUgPT09ICdUZXh0RWRpdG9yJykge1xuXHRcdGlmIChlZGl0b3IuYnVmZmVyICYmIGVkaXRvci5idWZmZXIuZWRpdG9yY29uZmlnKSB7XG5cdFx0XHRlZGl0b3IuYnVmZmVyLmVkaXRvcmNvbmZpZy5hcHBseVNldHRpbmdzKCk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdHN0YXR1c1RpbGUucmVtb3ZlSWNvbigpO1xuXHR9XG59XG5cbi8vIEhvb2sgaW50byB0aGUgZXZlbnRzIHRvIHJlY29nbml6ZSB0aGUgdXNlciBvcGVuaW5nIG5ldyBlZGl0b3JzIG9yIGNoYW5naW5nIHRoZSBwYW5lXG5jb25zdCBhY3RpdmF0ZSA9ICgpID0+IHtcblx0Z2VuZXJhdGVDb25maWcoKTtcblx0c2hvd1N0YXRlKCk7XG5cdGZpeEZpbGUoKTtcblx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKG9ic2VydmVUZXh0RWRpdG9yKTtcblx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKG9ic2VydmVBY3RpdmVQYW5lSXRlbSk7XG5cdHJlYXBwbHlFZGl0b3Jjb25maWcoKTtcblxuXHQvLyAjMjIwOiBGaXggc3B1cmlvdXMgXCJ0aHJhc2hpbmdcIiBpbiBvcGVuIGVkaXRvcnMgYXQgc3RhcnR1cFxuXHRpZiAoIWF0b20ucGFja2FnZXMuaGFzQWN0aXZhdGVkSW5pdGlhbFBhY2thZ2VzKCkpIHtcblx0XHRjb25zdCBkaXNwb3NhYmxlcyA9IG5ldyAoYXRtLkNvbXBvc2l0ZURpc3Bvc2FibGUpKCk7XG5cdFx0ZGlzcG9zYWJsZXMuYWRkKFxuXHRcdFx0YXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlUGFja2FnZShwa2cgPT4ge1xuXHRcdFx0XHRpZiAocGtnLm5hbWUgPT09ICd3aGl0ZXNwYWNlJyB8fCBwa2cubmFtZSA9PT0gJ3dyYXAtZ3VpZGUnKSB7XG5cdFx0XHRcdFx0cmVhcHBseUVkaXRvcmNvbmZpZygpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KSxcblx0XHRcdGF0b20ucGFja2FnZXMub25EaWRBY3RpdmF0ZUluaXRpYWxQYWNrYWdlcygoKSA9PiB7XG5cdFx0XHRcdGRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcblx0XHRcdFx0cmVhcHBseUVkaXRvcmNvbmZpZygpO1xuXHRcdFx0fSlcblx0XHQpO1xuXHR9XG59O1xuXG4vLyBDbGVhbiB0aGUgc3RhdHVzLWljb24gdXAsIHJlbW92ZSBhbGwgZW1iZWRkZWQgZWRpdG9yY29uZmlnLW9iamVjdHNcbmNvbnN0IGRlYWN0aXZhdGUgPSAoKSA9PiB7XG5cdGNvbnN0IHRleHRFZGl0b3JzID0gYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKTtcblx0dGV4dEVkaXRvcnMuZm9yRWFjaChlZGl0b3IgPT4ge1xuXHRcdGVkaXRvci5nZXRCdWZmZXIoKS5lZGl0b3Jjb25maWcuZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xuXHR9KTtcblx0c3RhdHVzVGlsZS5yZW1vdmVJY29uKCk7XG59O1xuXG4vLyBBcHBseSB0aGUgc3RhdHVzYmFyIGljb24tY29udGFpbmVyXG4vLyBUaGUgaWNvbiB3aWxsIGJlIGFwcGxpZWQgaWYgbmVlZGVkXG5jb25zdCBjb25zdW1lU3RhdHVzQmFyID0gc3RhdHVzQmFyID0+IHtcblx0aWYgKHN0YXR1c1RpbGUuY29udGFpbmVyRXhpc3RzKCkgPT09IGZhbHNlKSB7XG5cdFx0c3RhdHVzQmFyLmFkZFJpZ2h0VGlsZSh7XG5cdFx0XHRpdGVtOiBzdGF0dXNUaWxlLmNyZWF0ZUNvbnRhaW5lcigpLFxuXHRcdFx0cHJpb3JpdHk6IDk5OVxuXHRcdH0pO1xuXHR9XG59O1xuXG5leHBvcnQgZGVmYXVsdCB7YWN0aXZhdGUsIGRlYWN0aXZhdGUsIGNvbnN1bWVTdGF0dXNCYXJ9O1xuIl19